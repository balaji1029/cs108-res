<!DOCTYPE html><html lang="en">
<!-- Mirrored from www.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 12 Apr 2024 14:03:01 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><title>An Introduction to LuaTeX (Part 2): Understanding \directlua - Overleaf, Online LaTeX Editor</title><meta name="twitter:title" content="An Introduction to LuaTeX (Part 2): Understanding \directlua"><meta name="og:title" content="An Introduction to LuaTeX (Part 2): Understanding \directlua"><meta name="description" content="An online LaTeX editor that’s easy to use. No installation, real-time collaboration, version control, hundreds of LaTeX templates, and more."><meta itemprop="description" content="An online LaTeX editor that’s easy to use. No installation, real-time collaboration, version control, hundreds of LaTeX templates, and more."><meta itemprop="image" content="../../../../../cdn.overleaf.com/img/ol-brand/overleaf_og_logo.png"><meta name="image" content="../../../../../cdn.overleaf.com/img/ol-brand/overleaf_og_logo.png"><meta itemprop="name" content="Overleaf, the Online LaTeX Editor"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@overleaf"><meta name="twitter:description" content="An online LaTeX editor that’s easy to use. No installation, real-time collaboration, version control, hundreds of LaTeX templates, and more."><meta name="twitter:image" content="../../../../../cdn.overleaf.com/img/ol-brand/overleaf_og_logo.png"><meta property="fb:app_id" content="400474170024644"><meta property="og:description" content="An online LaTeX editor that’s easy to use. No installation, real-time collaboration, version control, hundreds of LaTeX templates, and more."><meta property="og:image" content="../../../../../cdn.overleaf.com/img/ol-brand/overleaf_og_logo.png"><meta property="og:type" content="website"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="icon" href="https://www.overleaf.com/favicon.ico"><link rel="icon" sizes="192x192" href="https://www.overleaf.com/touch-icon-192x192.png"><link rel="apple-touch-icon-precomposed" href="https://www.overleaf.com/apple-touch-icon-precomposed.png"><link rel="mask-icon" href="https://www.overleaf.com/mask-favicon.svg" color="#138A07"><link rel="canonical" href="directlua.html"><link rel="stylesheet" href="../../../../../cdn.overleaf.com/stylesheets/main-style-82a67b507675f5a9518e.css" id="main-stylesheet"><link rel="alternate" href="directlua.html" hreflang="en"><link rel="alternate" href="https://cs.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="cs"><link rel="alternate" href="https://es.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="es"><link rel="alternate" href="https://pt.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="pt"><link rel="alternate" href="https://fr.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="fr"><link rel="alternate" href="https://de.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="de"><link rel="alternate" href="https://sv.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="sv"><link rel="alternate" href="https://tr.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="tr"><link rel="alternate" href="https://it.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="it"><link rel="alternate" href="https://cn.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="zh-CN"><link rel="alternate" href="https://no.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="no"><link rel="alternate" href="https://ru.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="ru"><link rel="alternate" href="https://da.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="da"><link rel="alternate" href="https://ko.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="ko"><link rel="alternate" href="https://ja.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" hreflang="ja"><link rel="preload" href="../../../../../cdn.overleaf.com/js/en-json-5ee3d7a6fdd6e71a9730.js" as="script" nonce="8vk13NpFvb3+pNUSMNKbYg=="><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" id="ga-loader" data-ga-token="UA-112092690-1" data-ga-token-v4="G-RV4YBCCCWJ" data-cookie-domain=".overleaf.com">var gaSettings = document.querySelector('#ga-loader').dataset;
var gaid = gaSettings.gaTokenV4;
var gaToken = gaSettings.gaToken;
var cookieDomain = gaSettings.cookieDomain;
if(gaid) {
    window.dataLayer = window.dataLayer || [];
    function gtag(){
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', gaid, { 'anonymize_ip': true });
}
if (gaToken) {
    window.ga = window.ga || function () {
        (window.ga.q = window.ga.q || []).push(arguments);
    }, window.ga.l = 1 * new Date();
}
var loadGA = window.olLoadGA = function() {
    if (gaid) {
        var s = document.createElement('script');
        s.setAttribute('async', 'async');
        s.setAttribute('src', 'https://www.googletagmanager.com/gtag/js?id=' + gaid);
        document.querySelector('head').append(s);
    } 
    if (gaToken) {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','../../../../../www.google-analytics.com/analytics.js','ga');
        ga('create', gaToken, cookieDomain.replace(/^\./, ""));
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
    }
};
// Check if consent given (features/cookie-banner)
var oaCookie = document.cookie.split('; ').find(function(cookie) {
    return cookie.startsWith('oa=');
});
if(oaCookie) {
    var oaCookieValue = oaCookie.split('=')[1];
    if(oaCookieValue === '1') {
        loadGA();
    }
}
</script><meta name="ol-csrfToken" content="nZNsZvMa-TJx4OfBjUxfsVPYGNdBGfh_hMPg"><meta name="ol-baseAssetPath" content="https://cdn.overleaf.com/"><meta name="ol-mathJaxPath" content="/js/libs/mathjax-3.2.2/es5/tex-svg-full.js"><meta name="ol-usersEmail" content=""><meta name="ol-ab" data-type="json" content="{}"><meta name="ol-user_id"><meta name="ol-i18n" data-type="json" content="{&quot;currentLangCode&quot;:&quot;en&quot;}"><meta name="ol-ExposedSettings" data-type="json" content="{&quot;isOverleaf&quot;:true,&quot;appName&quot;:&quot;Overleaf&quot;,&quot;adminEmail&quot;:&quot;support@overleaf.com&quot;,&quot;dropboxAppName&quot;:&quot;Overleaf&quot;,&quot;ieeeBrandId&quot;:15,&quot;hasAffiliationsFeature&quot;:true,&quot;hasSamlFeature&quot;:true,&quot;samlInitPath&quot;:&quot;/saml/ukamf/init&quot;,&quot;hasLinkUrlFeature&quot;:true,&quot;hasLinkedProjectFileFeature&quot;:true,&quot;hasLinkedProjectOutputFileFeature&quot;:true,&quot;siteUrl&quot;:&quot;https://www.overleaf.com&quot;,&quot;emailConfirmationDisabled&quot;:false,&quot;maxEntitiesPerProject&quot;:2000,&quot;maxUploadSize&quot;:52428800,&quot;projectUploadTimeout&quot;:120000,&quot;recaptchaSiteKey&quot;:&quot;6LebiTwUAAAAAMuPyjA4pDA4jxPxPe2K9_ndL74Q&quot;,&quot;recaptchaDisabled&quot;:{&quot;invite&quot;:true,&quot;login&quot;:false,&quot;passwordReset&quot;:false,&quot;register&quot;:false,&quot;addEmail&quot;:false},&quot;textExtensions&quot;:[&quot;tex&quot;,&quot;latex&quot;,&quot;sty&quot;,&quot;cls&quot;,&quot;bst&quot;,&quot;bib&quot;,&quot;bibtex&quot;,&quot;txt&quot;,&quot;tikz&quot;,&quot;mtx&quot;,&quot;rtex&quot;,&quot;md&quot;,&quot;asy&quot;,&quot;lbx&quot;,&quot;bbx&quot;,&quot;cbx&quot;,&quot;m&quot;,&quot;lco&quot;,&quot;dtx&quot;,&quot;ins&quot;,&quot;ist&quot;,&quot;def&quot;,&quot;clo&quot;,&quot;ldf&quot;,&quot;rmd&quot;,&quot;lua&quot;,&quot;gv&quot;,&quot;mf&quot;,&quot;yml&quot;,&quot;yaml&quot;,&quot;lhs&quot;,&quot;mk&quot;,&quot;xmpdata&quot;,&quot;cfg&quot;,&quot;rnw&quot;,&quot;ltx&quot;,&quot;inc&quot;],&quot;editableFilenames&quot;:[&quot;latexmkrc&quot;,&quot;.latexmkrc&quot;,&quot;makefile&quot;,&quot;gnumakefile&quot;],&quot;validRootDocExtensions&quot;:[&quot;tex&quot;,&quot;Rtex&quot;,&quot;ltx&quot;,&quot;Rnw&quot;],&quot;fileIgnorePattern&quot;:&quot;**/{{__MACOSX,.git,.texpadtmp,.R}{,/**},.!(latexmkrc),*.{dvi,aux,log,toc,out,pdfsync,synctex,synctex(busy),fdb_latexmk,fls,nlo,ind,glo,gls,glg,bbl,blg,doc,docx,gz,swp}}&quot;,&quot;sentryAllowedOriginRegex&quot;:&quot;^(https://[a-z]+\\\\.overleaf.com|https://cdn.overleaf.com|https://compiles.overleafusercontent.com)/&quot;,&quot;sentryDsn&quot;:&quot;https://4f0989f11cb54142a5c3d98b421b930a@app.getsentry.com/34706&quot;,&quot;sentryEnvironment&quot;:&quot;production&quot;,&quot;sentryRelease&quot;:&quot;3d5f99705fbd6192ccae430e040be4b7fcb3f740&quot;,&quot;enableSubscriptions&quot;:true,&quot;gaToken&quot;:&quot;UA-112092690-1&quot;,&quot;gaTokenV4&quot;:&quot;G-RV4YBCCCWJ&quot;,&quot;cookieDomain&quot;:&quot;.overleaf.com&quot;,&quot;templateLinks&quot;:[{&quot;name&quot;:&quot;Academic Journal&quot;,&quot;url&quot;:&quot;/gallery/tagged/academic-journal&quot;,&quot;trackingKey&quot;:&quot;academic-journal&quot;},{&quot;name&quot;:&quot;Book&quot;,&quot;url&quot;:&quot;/gallery/tagged/book&quot;,&quot;trackingKey&quot;:&quot;book&quot;},{&quot;name&quot;:&quot;Formal Letter&quot;,&quot;url&quot;:&quot;/gallery/tagged/formal-letter&quot;,&quot;trackingKey&quot;:&quot;formal-letter&quot;},{&quot;name&quot;:&quot;Homework Assignment&quot;,&quot;url&quot;:&quot;/gallery/tagged/homework&quot;,&quot;trackingKey&quot;:&quot;homework-assignment&quot;},{&quot;name&quot;:&quot;Poster&quot;,&quot;url&quot;:&quot;/gallery/tagged/poster&quot;,&quot;trackingKey&quot;:&quot;poster&quot;},{&quot;name&quot;:&quot;Presentation&quot;,&quot;url&quot;:&quot;/gallery/tagged/presentation&quot;,&quot;trackingKey&quot;:&quot;presentation&quot;},{&quot;name&quot;:&quot;Project / Lab Report&quot;,&quot;url&quot;:&quot;/gallery/tagged/report&quot;,&quot;trackingKey&quot;:&quot;lab-report&quot;},{&quot;name&quot;:&quot;Résumé / CV &quot;,&quot;url&quot;:&quot;/gallery/tagged/cv&quot;,&quot;trackingKey&quot;:&quot;cv&quot;},{&quot;name&quot;:&quot;Thesis&quot;,&quot;url&quot;:&quot;/gallery/tagged/thesis&quot;,&quot;trackingKey&quot;:&quot;thesis&quot;},{&quot;name&quot;:&quot;view_all&quot;,&quot;url&quot;:&quot;/latex/templates&quot;,&quot;trackingKey&quot;:&quot;view-all&quot;}],&quot;labsEnabled&quot;:false,&quot;groupSSOEnabled&quot;:true,&quot;wikiEnabled&quot;:true,&quot;templatesEnabled&quot;:true}"><meta name="ol-splitTestVariants" data-type="json" content="{&quot;null-test-wiki&quot;:&quot;null-test&quot;}"><meta name="ol-splitTestInfo" data-type="json" content="{&quot;null-test-wiki&quot;:{&quot;phase&quot;:&quot;release&quot;}}"><meta name="ol-algolia" data-type="json" content="{&quot;appId&quot;:&quot;SK53GL4JLY&quot;,&quot;apiKey&quot;:&quot;9ac63d917afab223adbd2cd09ad0eb17&quot;,&quot;indexes&quot;:{&quot;wiki&quot;:&quot;learn-wiki&quot;,&quot;gallery&quot;:&quot;gallery-production&quot;}}"><meta name="ol-isManagedAccount" data-type="boolean"><meta name="ol-bootstrapVersion" data-type="json" content="3"></head><body ng-csp="no-unsafe-eval"><a class="skip-to-content" href="#main-content">Skip to content</a><nav class="navbar navbar-default navbar-main"><div class="container-fluid"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#navbar-main-collapse" aria-label="Toggle Navigation"><i class="fa fa-bars" aria-hidden="true"></i></button><a class="navbar-brand" href="../../../../index.html" aria-label="Overleaf"></a></div><div class="navbar-collapse collapse" id="navbar-main-collapse"><ul class="nav navbar-nav navbar-right"><!-- loop over header_extras--><li class="dropdown subdued"><a class="dropdown-toggle" href="#" role="button" aria-haspopup="true" aria-expanded="false" data-toggle="dropdown">Features & Benefits<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="https://www.overleaf.com/about/features-overview" event-tracking="menu-clicked-premium-features" event-tracking-mb="true" event-tracking-trigger="click">Features</a></li><li><a href="https://www.overleaf.com/for/enterprises" event-tracking="menu-clicked-enterprises" event-tracking-mb="true" event-tracking-trigger="click">For business</a></li><li><a href="https://www.overleaf.com/for/universities" event-tracking="menu-clicked-universities" event-tracking-mb="true" event-tracking-trigger="click">For universities</a></li><li><a href="https://www.overleaf.com/for/publishers" event-tracking="menu-clicked-publishers" event-tracking-mb="true" event-tracking-trigger="click">For publishers</a></li><li><a href="https://www.overleaf.com/for/edu" event-tracking="menu-clicked-edu" event-tracking-mb="true" event-tracking-trigger="click">For teaching</a></li></ul></li><li class="subdued"><a class="subdued" href="https://www.overleaf.com/latex/templates" event-tracking="menu-clicked-templates" event-tracking-mb="true" event-tracking-trigger="click">Templates</a></li><li class="subdued"><a class="subdued" href="https://www.overleaf.com/user/subscription/plans" event-tracking="menu-clicked-plans" event-tracking-mb="true" event-tracking-trigger="click">Plans &amp; Pricing</a></li><li class="dropdown subdued"><a class="dropdown-toggle" href="#" role="button" aria-haspopup="true" aria-expanded="false" data-toggle="dropdown">Help<span class="caret"></span></a><ul class="dropdown-menu"><li><a href="https://www.overleaf.com/about/why-latex" event-tracking="menu-clicked-why-latex" event-tracking-mb="true" event-tracking-trigger="click">Why LaTeX?</a></li><li><a href="../../../../learn.html" event-tracking="menu-clicked-learn" event-tracking-mb="true" event-tracking-trigger="click">Documentation</a></li><li><a data-ol-open-contact-form-modal="contact-us" href><span event-tracking="menu-clicked-contact" event-tracking-mb="true" event-tracking-trigger="click">Contact Us</span></a></li></ul></li><!-- logged out--><!-- register link--><li class="primary"><a href="https://www.overleaf.com/register" event-tracking="menu-clicked-register" event-tracking-action="clicked" event-tracking-trigger="click" event-tracking-mb="true" event-segmentation="{&quot;page&quot;:&quot;/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua&quot;}">Sign up</a></li><!-- login link--><li><a href="https://www.overleaf.com/login" event-tracking="menu-clicked-login" event-tracking-action="clicked" event-tracking-trigger="click" event-tracking-mb="true" event-segmentation="{&quot;page&quot;:&quot;/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua&quot;}">Log in</a></li><!-- projects link and account menu--></ul></div></div></nav><main class="content content-page content-alt" id="main-content"><div class="container wiki" ng-cloak><div class="row template-page-header"><div class="col-md-8" ng-cloak></div></div><div class="row"><div class="col-xs-12 col-sm-9 col-sm-push-3 page"><div class="wiki"><form class="project-search form-horizontal" role="search" data-ol-faq-search="data-ol-faq-search"><div class="form-group has-feedback has-feedback-left"><div class="col-sm-12"><input class="form-control" type="text" placeholder="Search help library…"/><i class="fa fa-search form-control-feedback-left" aria-hidden="true"></i><i class="fa fa-times form-control-feedback" style="cursor: pointer;" hidden="hidden" data-ol-clear-search="data-ol-clear-search" aria-hidden="true"></i><button class="sr-only" type="button" hidden="hidden" data-ol-clear-search="data-ol-clear-search" aria-label="clear search"></button></div></div><div class="row" role="region" aria-label="search results"><div class="col-md-12"><div data-ol-search-results-wrapper="data-ol-search-results-wrapper"><span class="sr-only" aria-live="polite" data-ol-search-sr-help-message="data-ol-search-sr-help-message"></span><div data-ol-search-results="data-ol-search-results"></div></div><div class="row-spaced-small search-result card card-thin" hidden="hidden" data-ol-search-no-results="data-ol-search-no-results"><p>No Search Results</p></div></div></div></form></div><div class="card row-spaced"><div class="page-header"><h1 ng-non-bindable>An Introduction to LuaTeX (Part 2): Understanding \directlua</h1></div><div data-ol-mathjax><div ng-non-bindable><div class="mw-parser-output"><div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none" /><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#The_goal_of_this_article"><span class="tocnumber">1</span> <span class="toctext">The goal of this article</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Introduction_to_the_Lua_in_LuaTeX"><span class="tocnumber">2</span> <span class="toctext">Introduction to the Lua in LuaTeX</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#Using_Lua_and_TeX_in_your_document:_enter_\directlua"><span class="tocnumber">2.1</span> <span class="toctext">Using Lua and TeX in your document: enter \directlua</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#More_formal_description_of_\directlua"><span class="tocnumber">2.2</span> <span class="toctext">More formal description of \directlua</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-5"><a href="#Understanding_\directlua:_Which_topics_will_we_cover?"><span class="tocnumber">3</span> <span class="toctext">Understanding \directlua: Which topics will we cover?</span></a></li>
<li class="toclevel-1 tocsection-6"><a href="#The_foundations:_from_text_to_tokens_and_tokens_to_text"><span class="tocnumber">4</span> <span class="toctext">The foundations: from text to tokens and tokens to text</span></a>
<ul>
<li class="toclevel-2 tocsection-7"><a href="#Understanding_character_tokens"><span class="tocnumber">4.1</span> <span class="toctext">Understanding character tokens</span></a>
<ul>
<li class="toclevel-3 tocsection-8"><a href="#How_are_character_tokens_calculated?"><span class="tocnumber">4.1.1</span> <span class="toctext">How are character tokens calculated?</span></a>
<ul>
<li class="toclevel-4 tocsection-9"><a href="#Active_characters"><span class="tocnumber">4.1.1.1</span> <span class="toctext">Active characters</span></a></li>
<li class="toclevel-4 tocsection-10"><a href="#Examples"><span class="tocnumber">4.1.1.2</span> <span class="toctext">Examples</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-2 tocsection-11"><a href="#Understanding_command_tokens"><span class="tocnumber">4.2</span> <span class="toctext">Understanding command tokens</span></a>
<ul>
<li class="toclevel-3 tocsection-12"><a href="#How_are_command_tokens_calculated?"><span class="tocnumber">4.2.1</span> <span class="toctext">How are command tokens calculated?</span></a>
<ul>
<li class="toclevel-4 tocsection-13"><a href="#Examples_2"><span class="tocnumber">4.2.1.1</span> <span class="toctext">Examples</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-2 tocsection-14"><a href="#How_a_TeX_engine_identifies_the_type_of_token_(command_or_character)"><span class="tocnumber">4.3</span> <span class="toctext">How a TeX engine identifies the type of token (command or character)</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-15"><a href="#Tokens_can_be_broken_apart_(and_converted_back_to_text)"><span class="tocnumber">5</span> <span class="toctext">Tokens can be broken apart (and converted back to text)</span></a>
<ul>
<li class="toclevel-2 tocsection-16"><a href="#Why_is_\(\text{curcs}\)_so_important?"><span class="tocnumber">5.1</span> <span class="toctext">Why is \(\text{curcs}\) so important?</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="#Converting_integer_tokens_back_to_characters_or_character_sequences_(command_names)"><span class="tocnumber">5.2</span> <span class="toctext">Converting integer tokens back to characters or character sequences (command names)</span></a>
<ul>
<li class="toclevel-3 tocsection-18"><a href="#Converting_character_tokens_to_text"><span class="tocnumber">5.2.1</span> <span class="toctext">Converting character tokens to text</span></a></li>
<li class="toclevel-3 tocsection-19"><a href="#Converting_command_tokens_to_text"><span class="tocnumber">5.2.2</span> <span class="toctext">Converting command tokens to text</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-20"><a href="#Token_lists"><span class="tocnumber">6</span> <span class="toctext">Token lists</span></a>
<ul>
<li class="toclevel-2 tocsection-21"><a href="#A_token_list_in_graphic_form"><span class="tocnumber">6.1</span> <span class="toctext">A token list in graphic form</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-22"><a href="#How_\directlua_really_works"><span class="tocnumber">7</span> <span class="toctext">How \directlua really works</span></a>
<ul>
<li class="toclevel-2 tocsection-23"><a href="#How_LuaTeX_processes_\directlua:_A_first_look"><span class="tocnumber">7.1</span> <span class="toctext">How LuaTeX processes \directlua: A first look</span></a></li>
<li class="toclevel-2 tocsection-24"><a href="#How_LuaTeX_processes_\directlua:_A_second_look_(at_expansion)"><span class="tocnumber">7.2</span> <span class="toctext">How LuaTeX processes \directlua: A second look (at expansion)</span></a>
<ul>
<li class="toclevel-3 tocsection-25"><a href="#Refining_our_“definition”_of_expansion"><span class="tocnumber">7.2.1</span> <span class="toctext">Refining our “definition” of expansion</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-26"><a href="#How_LuaTeX_processes_\directlua:_A_final_look"><span class="tocnumber">7.3</span> <span class="toctext">How LuaTeX processes \directlua: A final look</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-27"><a href="#Expansion_as_a_programming_language_“interface”"><span class="tocnumber">8</span> <span class="toctext">Expansion as a programming language “interface”</span></a></li>
<li class="toclevel-1 tocsection-28"><a href="#Tokens_in_the_\directlua_token_list:_non-expandable_tokens_and_unexpanded_tokens"><span class="tocnumber">9</span> <span class="toctext">Tokens in the \directlua token list: non-expandable tokens and unexpanded tokens</span></a>
<ul>
<li class="toclevel-2 tocsection-29"><a href="#Two_“groups”_of_token_in_a_\directlua_token_list"><span class="tocnumber">9.1</span> <span class="toctext">Two “groups” of token in a \directlua token list</span></a>
<ul>
<li class="toclevel-3 tocsection-30"><a href="#Shorthand_command_tokens:_creating_non-expandable_commands"><span class="tocnumber">9.1.1</span> <span class="toctext">Shorthand command tokens: creating non-expandable commands</span></a>
<ul>
<li class="toclevel-4 tocsection-31"><a href="#Brief_notes_on_plain_TeX_vs._LaTeX"><span class="tocnumber">9.1.1.1</span> <span class="toctext">Brief notes on plain TeX vs. LaTeX</span></a></li>
<li class="toclevel-4 tocsection-32"><a href="#How_does_this_affect_\directlua?"><span class="tocnumber">9.1.1.2</span> <span class="toctext">How does this affect \directlua?</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-2 tocsection-33"><a href="#Unexpanded_tokens:_suppressing_expansion"><span class="tocnumber">9.2</span> <span class="toctext">Unexpanded tokens: suppressing expansion</span></a>
<ul>
<li class="toclevel-3 tocsection-34"><a href="#\noexpand_⟨token⟩"><span class="tocnumber">9.2.1</span> <span class="toctext">\noexpand ⟨token⟩</span></a>
<ul>
<li class="toclevel-4 tocsection-35"><a href="#Example"><span class="tocnumber">9.2.1.1</span> <span class="toctext">Example</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-36"><a href="#\unexpanded{⟨material⟩}"><span class="tocnumber">9.2.2</span> <span class="toctext">\unexpanded{⟨material⟩}</span></a>
<ul>
<li class="toclevel-4 tocsection-37"><a href="#Example_2"><span class="tocnumber">9.2.2.1</span> <span class="toctext">Example</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-38"><a href="#\protected_macro_definitions"><span class="tocnumber">9.2.3</span> <span class="toctext">\protected macro definitions</span></a>
<ul>
<li class="toclevel-4 tocsection-39"><a href="#Example_3"><span class="tocnumber">9.2.3.1</span> <span class="toctext">Example</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-2 tocsection-40"><a href="#Unexpanded_tokens:_Using_\the\toks_in_\directlua"><span class="tocnumber">9.3</span> <span class="toctext">Unexpanded tokens: Using \the\toks in \directlua</span></a>
<ul>
<li class="toclevel-3 tocsection-41"><a href="#Brief_background_on_\toks"><span class="tocnumber">9.3.1</span> <span class="toctext">Brief background on \toks</span></a></li>
<li class="toclevel-3 tocsection-42"><a href="#Back_to_\directlua"><span class="tocnumber">9.3.2</span> <span class="toctext">Back to \directlua</span></a>
<ul>
<li class="toclevel-4 tocsection-43"><a href="#Example_4"><span class="tocnumber">9.3.2.1</span> <span class="toctext">Example</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-44"><a href="#Other_commands/techniques_used_in_expansion"><span class="tocnumber">10</span> <span class="toctext">Other commands/techniques used in expansion</span></a>
<ul>
<li class="toclevel-2 tocsection-45"><a href="#\string_⟨token⟩"><span class="tocnumber">10.1</span> <span class="toctext">\string ⟨token⟩</span></a></li>
<li class="toclevel-2 tocsection-46"><a href="#\detokenize{⟨material⟩}"><span class="tocnumber">10.2</span> <span class="toctext">\detokenize{⟨material⟩}</span></a></li>
<li class="toclevel-2 tocsection-47"><a href="#Example_5"><span class="tocnumber">10.3</span> <span class="toctext">Example</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-48"><a href="#What_are_“Lua_escape_sequences”?"><span class="tocnumber">11</span> <span class="toctext">What are “Lua escape sequences”?</span></a>
<ul>
<li class="toclevel-2 tocsection-49"><a href="#Controlling_escape_sequences"><span class="tocnumber">11.1</span> <span class="toctext">Controlling escape sequences</span></a></li>
<li class="toclevel-2 tocsection-50"><a href="#Why_are_long_bracket_strings_so_useful?"><span class="tocnumber">11.2</span> <span class="toctext">Why are long bracket strings so useful?</span></a>
<ul>
<li class="toclevel-3 tocsection-51"><a href="#Long-bracket_strings_come_to_the_rescue!"><span class="tocnumber">11.2.1</span> <span class="toctext">Long-bracket strings come to the rescue!</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-52"><a href="#Expansion_and_non-execution_of_non-expandable_commands"><span class="tocnumber">11.3</span> <span class="toctext">Expansion and non-execution of non-expandable commands</span></a>
<ul>
<li class="toclevel-3 tocsection-53"><a href="#Example_6"><span class="tocnumber">11.3.1</span> <span class="toctext">Example</span></a></li>
<li class="toclevel-3 tocsection-54"><a href="#Caution:_macros_and_the_LuaTeX_Lua_API"><span class="tocnumber">11.3.2</span> <span class="toctext">Caution: macros and the LuaTeX Lua API</span></a>
<ul>
<li class="toclevel-4 tocsection-55"><a href="#Rewriting_our_macro_to_use_the_LuaTeX_Lua_API"><span class="tocnumber">11.3.2.1</span> <span class="toctext">Rewriting our macro to use the LuaTeX Lua API</span></a></li>
<li class="toclevel-4 tocsection-56"><a href="#Example:_unexpected_side-effects"><span class="tocnumber">11.3.2.2</span> <span class="toctext">Example: unexpected side-effects</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-57"><a href="#Brief_introduction_to_LuaTeX’s_Lua_API"><span class="tocnumber">12</span> <span class="toctext">Brief introduction to LuaTeX’s Lua API</span></a></li>
<li class="toclevel-1 tocsection-58"><a href="#Some_examples_and_pitfalls"><span class="tocnumber">13</span> <span class="toctext">Some examples and pitfalls</span></a>
<ul>
<li class="toclevel-2 tocsection-59"><a href="#Challenges_using_\\_in_\directlua"><span class="tocnumber">13.1</span> <span class="toctext">Challenges using \\ in \directlua</span></a>
<ul>
<li class="toclevel-3 tocsection-60"><a href="#Solution_1:_\let\\\relax"><span class="tocnumber">13.1.1</span> <span class="toctext">Solution 1: \let\\\relax</span></a></li>
<li class="toclevel-3 tocsection-61"><a href="#Solution_2:_\noexpand"><span class="tocnumber">13.1.2</span> <span class="toctext">Solution 2: \noexpand</span></a></li>
<li class="toclevel-3 tocsection-62"><a href="#Solution_3:_Using_a_string.char()_“trick”"><span class="tocnumber">13.1.3</span> <span class="toctext">Solution 3: Using a string.char() “trick”</span></a></li>
<li class="toclevel-3 tocsection-63"><a href="#Solution_4:_Using_\string\\"><span class="tocnumber">13.1.4</span> <span class="toctext">Solution 4: Using \string\\</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-64"><a href="#Using_the_tilde_character_(~)"><span class="tocnumber">13.2</span> <span class="toctext">Using the tilde character (~)</span></a>
<ul>
<li class="toclevel-3 tocsection-65"><a href="#Using_\string⟨token⟩"><span class="tocnumber">13.2.1</span> <span class="toctext">Using \string⟨token⟩</span></a></li>
<li class="toclevel-3 tocsection-66"><a href="#Using_\noexpand⟨token⟩"><span class="tocnumber">13.2.2</span> <span class="toctext">Using \noexpand⟨token⟩</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-67"><a href="#Using_the_#_character"><span class="tocnumber">13.3</span> <span class="toctext">Using the # character</span></a>
<ul>
<li class="toclevel-3 tocsection-68"><a href="#Example_7"><span class="tocnumber">13.3.1</span> <span class="toctext">Example</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-69"><a href="#Using_the_%_character"><span class="tocnumber">13.4</span> <span class="toctext">Using the % character</span></a>
<ul>
<li class="toclevel-3 tocsection-70"><a href="#Example_8"><span class="tocnumber">13.4.1</span> <span class="toctext">Example</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-71"><a href="#Why_is_Lua_code_shown_on_a_single_line?"><span class="tocnumber">14</span> <span class="toctext">Why is Lua code shown on a single line?</span></a>
<ul>
<li class="toclevel-2 tocsection-72"><a href="#How_TeX_engines_deal_with_line_endings"><span class="tocnumber">14.1</span> <span class="toctext">How TeX engines deal with line endings</span></a>
<ul>
<li class="toclevel-3 tocsection-73"><a href="#Step_1:_TeX_inserts_its_own_end-of-line_character"><span class="tocnumber">14.1.1</span> <span class="toctext">Step 1: TeX inserts its own end-of-line character</span></a></li>
<li class="toclevel-3 tocsection-74"><a href="#Step_2:_TeX_converts_its_end-of-line_character_to_a_space"><span class="tocnumber">14.1.2</span> <span class="toctext">Step 2: TeX converts its end-of-line character to a space</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-75"><a href="#TeX’s_bizarre_^^_notation"><span class="tocnumber">14.2</span> <span class="toctext">TeX’s bizarre ^^ notation</span></a></li>
<li class="toclevel-2 tocsection-76"><a href="#Changing_the_character_assigned_to_\endlinechar"><span class="tocnumber">14.3</span> <span class="toctext">Changing the character assigned to \endlinechar</span></a></li>
<li class="toclevel-2 tocsection-77"><a href="#Changing_the_category_code_of_\r"><span class="tocnumber">14.4</span> <span class="toctext">Changing the category code of \r</span></a>
<ul>
<li class="toclevel-3 tocsection-78"><a href="#Why_did_\r_use_category_code_12_but_not_category_code_11?"><span class="tocnumber">14.4.1</span> <span class="toctext">Why did \r use category code 12 but not category code 11?</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-79"><a href="#Why_are_we_worrying_about_end-of-lines?"><span class="tocnumber">14.5</span> <span class="toctext">Why are we worrying about end-of-lines?</span></a>
<ul>
<li class="toclevel-3 tocsection-80"><a href="#Block_comments"><span class="tocnumber">14.5.1</span> <span class="toctext">Block comments</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-81"><a href="#In_conclusion"><span class="tocnumber">15</span> <span class="toctext">In conclusion</span></a>
<ul>
<li class="toclevel-2 tocsection-82"><a href="#And_finally..._just_use_the_luacode_package"><span class="tocnumber">15.1</span> <span class="toctext">And finally... just use the luacode package</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="The_goal_of_this_article">The goal of this article</span></h2>
<p class="mw-empty-elt">
</p><p>In the first part of this article, <a href="../An_Introduction_to_LuaTeX_(Part_1)__What_is_it%e2%80%94and_what_makes_it_so_different_.html">An Introduction to LuaTeX (Part 1): What is it—and what makes it so different?</a>, we briefly reviewed LuaTeX as an extremely versatile TeX engine: a sophisticated, programmable, typesetting system which provides a wide range of tools for constructing document engineering and production solutions.</p> 

<p class="mw-empty-elt"></p>
<p>In this concluding installment, we take a close look at the most vital component of the LuaTeX toolbox: the <code>\directlua</code> command which provides the “gateway” to programmatic control of LuaTeX’s typesetting through the Lua scripting language.</p> 
<p>However, fully exploiting LuaTeX via <code>\directlua</code> requires some background knowledge of several  TeX topics: TeX’s tokens, token lists and expansion mechanism. The goal of this article is to explore and explain these fundamental TeX concepts: piecing together the TeX-related processes behind <code>\directlua</code> to develop an understanding of how it works and provide the foundations upon which to build your own typesetting solutions using LuaTeX.</p>
<p>This article includes numerous short examples to demonstrate and explain key aspects of <code>\directlua</code>’s behaviour, deliberately avoiding overly-complex code in favour of short code fragments. Where necessary, examples use basic (raw/plain) TeX—although most people use and prefer LaTeX (macros), basic TeX commands have the advantage of simplicity.</p>
<h2><span class="mw-headline" id="Introduction_to_the_Lua_in_LuaTeX">Introduction to the Lua in LuaTeX</span></h2>
<p class="mw-empty-elt"></p><p>
<a href="https://www.lua.org/about.html">Lua</a> is a scripting language whose <a href="https://www.lua.org/download.html">source code</a> is highly portable and easy to embed into software applications, allowing developers to incorporate scripting capabilities into their programs. Lua has been embedded into <a href="https://en.wikipedia.org/wiki/List_of_applications_using_Lua">many applications</a> and is a popular choice within the software games industry—perhaps the most famous example is <a href="https://wowwiki.fandom.com/wiki/Lua_functions">World of Warcraft</a>.</p>

<p class="mw-empty-elt"></p>
<p>LuaTeX, as its name suggests, is a TeX engine which embeds the Lua scripting language, providing users with the ability to control LuaTeX’s typesetting behaviour by including Lua programs (scripts) into their documents. In addition to direct control of LuaTeX, users can  leverage Lua purely as a very capable programming language to perform tasks that might be extremely difficult to achieve using the TeX language—which is, by any fair measure, a challenge to learn and master. Through the addition and integration of Lua, LuaTeX becomes a very versatile and powerful TeX engine which directly supports two programming languages. </p>
<h3><span id="Using_Lua_and_TeX_in_your_document:_enter_.5Cdirectlua"></span><span class="mw-headline" id="Using_Lua_and_TeX_in_your_document:_enter_\directlua">Using Lua and TeX in your document: enter <code>\directlua</code></span></h3>
<p>Lua and TeX are two <em>very different</em> programming languages: Lua is much closer to what most people think of as a programming language but TeX, with its category codes, tokens, macros and expansion mechanism is far removed from most peoples’ experiences/expectations of a language in which to write programs. However, as history has shown, the TeX language has endured because it is good at what it was designed for: controlling typesetting, even if its mode of operation is somewhat arcane.</p>
<p>To address the challenge of mixing the Lua and TeX languages in a single TeX document, LuaTeX’s developers introduced a new command called <code>\directlua</code> which is the route to using Lua—both as a standalone programming language in its own right and for controlling LuaTeX’s typesetting behaviour.</p>
<p>The <code>\directlua</code> command allows users to embed Lua code in their TeX documents; that code is subsequently passed on to LuaTeX’s built-in Lua language interpreter. However, <code>\directlua</code> also allows you to <em>combine</em> Lua and (La)TeX code together, within the same <code>\directlua</code> command—although that introduces additional complexities due to fundamental differences in Lua and TeX-based programming languages. The key challenge when using a combination of (La)TeX and Lua code is to ensure those two languages co-exist peacefully and don’t get “in each other’s way”. </p>
<p><code>\directlua</code> is best suited for use with shorter in-document Lua code fragments but you can use it with more extensive Lua programs, should you wish to. Generally, more substantial Lua programs, and Lua code libraries, are saved to external files which can be loaded by using Lua’s <code>dofile()</code> function within a <code>\directlua</code> command. From the TeX-processing standpoint, a significant advantage of using external Lua code files is avoidance of complications that arise from TeX’s category code mechanism—a topic fully explored in this article.</p>
<h3><span id="More_formal_description_of_.5Cdirectlua"></span><span class="mw-headline" id="More_formal_description_of_\directlua">More formal description of <code>\directlua</code></span></h3>
<p class="mw-empty-elt"></p><p>The <a href="http://www.pragma-ade.com/general/manuals/luatex.pdf">LuaTeX Reference Manual</a> describes <code>\directlua</code> as follows (slightly modified):</p>
<p class="mw-empty-elt"></p>
<blockquote><p>In order to merge Lua code with TeX input, a few new primitives are needed. The primitive <code>\directlua</code> is used to execute Lua code immediately. The basic syntax is <code>\directlua{⟨code⟩}</code>. The <code>⟨code⟩</code> is expanded fully, and then fed into the Lua interpreter. After reading and expansion has been applied to the <code>⟨code⟩</code>, the resulting token list is converted to a string as if it was displayed using <code>\the\toks</code>.
</p></blockquote>
<p>Of course this is technically accurate but, perhaps, not so easy to understand without some knowledge of lower-level TeX processes—such as tokens and expansion.</p>
<h2><span id="Understanding_.5Cdirectlua:_Which_topics_will_we_cover.3F"></span><span class="mw-headline" id="Understanding_\directlua:_Which_topics_will_we_cover?">Understanding <code>\directlua</code>: Which topics will we cover?</span></h2>
<p>In this article we’ll take a closer look at some key background topics and offer a number of examples designed to demonstrate how <code>\directlua</code> works and where (or why) you need to be careful when combining TeX and Lua in your <code>⟨code⟩</code>.</p>
<p>We’ll explore the following topics in sufficient detail to provide a foundation for understanding <code>\directlua</code> and its “pre-processing” of the code you use within it:</p>
<ul>
<li>category codes and TeX tokens: converting text to tokens and tokens to text;</li>
<li>TeX’s expansion process (and preventing expansion);</li>
<li>Lua escape sequences/mechanisms for characters and strings;</li>
<li>using Lua-style comments;</li> 
<li>a short introduction to LuaTeX’s Lua API.</li>
</ul>
<p>If you understand how TeX engines create and use tokens and develop an awareness of TeX’s expansion mechanism then you’ll have the foundations necessary to unlock the incredible versatility of LuaTeX’s <code>\directlua</code> command.</p>
<h2><span class="mw-headline" id="The_foundations:_from_text_to_tokens_and_tokens_to_text">The foundations: from text to tokens and tokens to text</span></h2>
<p>Overleaf has published several articles which take an in-depth look at TeX tokens and related concepts so we won’t repeat all that material here; instead, we’ll outline those areas/topics relevant to developing a better understanding of <code>\directlua</code>.</p>
<p>Here is a list of previously published articles which may be of interest:</p>
<p class="mw-empty-elt">
</p><ul>
<li><a href="../What_is_a__TeX_token__.html">What is a TeX token?</a></li>
<li><a href="../What_is_a_TeX_token_list.html">What is a TeX token list?</a></li>
<li><a href="../How_does_/expandafter_work__An_introduction_to_TeX_tokens.html">How does \expandafter work: An introduction to TeX tokens</a></li>
<li><a href="../../A_six-part_series__How_do_TeX_macros_actually_work_.html">A six-part series: How do TeX macros actually work?</a></li>
</ul>

<p class="mw-empty-elt"></p>
<h3><span class="mw-headline" id="Understanding_character_tokens">Understanding character tokens</span></h3>
<p>Any character a TeX engine can read from a text file is represented by two numeric values:</p>
<ul>
<li>its <em>character code</em> (ASCII value or, today, its Unicode code point);</li> 
<li>a second, TeX-centric, value called its <em>category code</em>.</li>
</ul>
<p class="mw-empty-elt"></p><p>Readers who would like to know more about category codes may be interested to read this introduction published by Overleaf: <a href="../../How_TeX_macros_actually_work__Part_1.html#So.2C_where_do_we_start.3F_With_category_codes.">So where do we start? With category codes</a>.</p>
<p class="mw-empty-elt"></p>
<p>For example, if a TeX engine reads-in a character <code>A</code> it would have access to two pieces of information: <code>A</code>’s character code (65), and its category code (11, usually). Once TeX has input that character <code>A</code>, its category code won’t be changed but user macros can make category code changes that might affect any <em>subsequent</em> character <code>A</code> which <em>has not yet been read</em> by TeX. Consequently, TeX needs to record that <em>this</em> character <code>A</code>, <em>just read in</em>, has category code 11. To do that TeX uses the integer pair (65,11) to calculate another integer value that it calls a <em>character token</em>. By calculating that token value, which is passed on to TeX’s inner processing, that particular <code>A</code> and its category code are <em>bound together</em>; in effect, that character token <em>encapsulates</em> the data TeX needs to know about that character for use in any subsequent typesetting activities deeper inside the TeX engine.</p>
<h4><span id="How_are_character_tokens_calculated.3F"></span><span class="mw-headline" id="How_are_character_tokens_calculated?">How are character tokens calculated?</span></h4>
<p>Firstly, we need to remember that TeX engines use category code 13 for the purpose of creating so-called <em>active characters</em>: any character with category code 13 behaves like a mini-macro; consequently, and as we’ll see below, tokens for active characters are calculated differently to regular characters with other category codes such as 10, 11 or 12.</p>
<p>For <em>non-active</em> characters:</p>
<ul>
<li>older 8-bit engines (Knuth’s TeX, e-TeX, pdfTeX) calculate character tokens for <em>non-active</em> characters using</li>
</ul>
<p>\[\text{(non-active) character token} = (256 \times \text{category code}) + (\text{ASCII character code})\]</p>
<ul>
<li>for LuaTeX, which has to deal with Unicode character values, the calculation for <em>non-active</em> characters is similar but produces much larger integer values:</li>
</ul>
<p>\[ \text{(non-active) character token} = (2^{21} \times \text{category code}) + (\text{Unicode value})\]</p>
<p>Going back to our earlier example for the letter A with category code 11, LuaTeX would calculate a character token value of \(2^{21} \times 11 + 65 = 23068737\). Once calculated, that character token value <em>binds</em> that particular character A to a category code value of 11. User macros may change the category code for any subsequent character A, but this one’s category code has been fixed by converting it to a token for use as it passes through LuaTeX’s inner workings. LuaTeX has preserved, or encapsulated, the intended meaning of that character as determined at the time it was read in.</p>
<p class="mw-empty-elt"></p><p>TeX engines use a total of <a href="../../Table_of_TeX_category_codes.html">16 different category codes</a> and <em>any</em> of those category codes can be assigned, via the <code>\catcode</code> command, to <em>any</em> character the TeX engine is capable of reading. Changes to category codes are used to alter the way TeX engines process particular characters in the input, allowing TeX users to write macros that produce special typesetting results or behaviour.</p>
<p class="mw-empty-elt"></p>
<h5><span class="mw-headline" id="Active_characters">Active characters</span></h5>
<p>As noted, TeX engines use category code 13 to attach a “special meaning” to a character, making it a so-called <em>active character</em> which behaves like a mini-macro: no leading <code>\</code> is required, the isolated character, due to its category code, is enough to trigger its macro-like behaviour.</p>
<p>Because an active character acts as a mini-macro, it is not converted to a <em>character token</em> but to a second (integer) token type called a <em>command token</em>. These are calculated as follows:</p>
<ul>
<li>for older 8-bit engines (Knuth’s TeX, e-TeX, pdfTeX) tokens for active characters are calculated via:</li>
<ol>
<li>calculate an intermediate value called \(\text{curcs}\) (<strong>cur</strong>rent <strong>c</strong>ontrol <strong>s</strong>equence) where</li> 
   
\[\text{curcs} = \text{character code} + 1\]

<li>calculate the token value where</li> 

\[\text{active character token} = \text{curcs} + \text{4095}\]

</ol>
<li>for LuaTeX the calculation is a little more complex because it has to deal with the full range of Unicode characters, any one of which could be made active:</li>
<ol>
<li>calculate the intermediate integer value \(\text{curcs}\) by applying a so-called <em>hash function</em> to the active character’s Unicode code point value expressed in UTF-8:</li>

\[ \text{curcs}=\texttt{hashfunction}\text{(UTF-8 text for Unicode value of active character)}\]

<li>calculate the integer token value:</li>

\[\text{active character token} = \text{curcs} + 2^{29} - 1\]
</ol>
</ul>
<h5><span class="mw-headline" id="Examples">Examples</span></h5>
<ul>
<li>8-bit engines: the token calculation for the active character <code>~</code> (character code 126) results in \(\text{curcs} = 126 + 1 = 127\), giving a token value of \(4095 + 127 = 4222\).

</li><li>LuaTeX: the token calculation for the active character <code>~</code> results in \(\text{curcs}=3186\) giving a token value of \(3186 + 2^{29} - 1 = 536874097\). LuaTeX tokens use much larger integer values!
</li>
</ul>
<h3><span class="mw-headline" id="Understanding_command_tokens">Understanding command tokens</span></h3>
<p>In addition to processing <em>individual</em> characters, TeX engines can, of course, process <em>sequences</em> of characters called <em>commands</em> (or, more correctly, <em>control sequences</em>). By tradition, the <code>\</code> character is used to signal the start of a command but that’s merely a convention—in fact, any character with category code 0 (the escape character) could be used instead.</p>
<p>TeX engines recognize two types of command which are known as <em>control words</em> and <em>control symbols</em>:</p>
<ul>
   <li><strong>control words</strong>: commands constructed from one or more characters that have category code 11; 
    </li><li><strong>control symbols</strong>: single-character commands where that character’s category code <em>is not</em> 11: such as <code>\$</code>, <code>\#</code> or <code>\\</code>.</li>
</ul>
<p><strong>Note</strong>: The TeX primitives <code>\chardef</code>, <code>\mathchardef</code>, <code>\countdef</code>, <code>\dimendef</code>, <code>\skipdef</code>, <code>\muskipdef</code> and <code>\toksdef</code> are also used to define control sequences but, unlike regular macro definitions, the resulting control sequences (control words or control symbols) <em>are not expandable</em>—we’ll explore these in more detail below.</p>
<h4><span id="How_are_command_tokens_calculated.3F"></span><span class="mw-headline" id="How_are_command_tokens_calculated?">How are command tokens calculated?</span></h4>
<p>Just like active characters, TeX engines use the second type of integer token value to represent commands: <em>command tokens</em>—recall that active characters also generate command tokens because they behave as mini-macros.</p>
<p class="mw-empty-elt"></p><p>The calculations used by 8-bit engines to create command-token integers can be found in this <a href="../How_does_/expandafter_work__An_introduction_to_TeX_tokens.html#How_TeX_calculates_token_values">Overleaf article</a>. Here, we will summarize the key steps in command token calculations for LuaTeX—which are slightly different because LuaTeX has to process Unicode character code values which can be considerably larger than 8-bit values; however, LuaTeX’s calculations follow the same general principles used by older 8-bit engines.</p>
<p class="mw-empty-elt"></p>
<p>After detecting an incoming command, TeX engines, including LuaTeX, ignore the leading <code>\</code> character: it is not used in calculations of command token values but merely acts as a “switch” to inform a TeX engine it needs to process a command. The command token value is calculated using the sequence of (1 or more) characters present in the name of the command—LuaTeX calculates command tokens for control symbols and control words using the same algorithm:</p>
<ol>
<li>calculate the intermediate integer value \(\text{curcs}\) by applying a so-called <a href="https://en.wikipedia.org/wiki/Hash_function">hash function</a> to the Unicode UTF-8 string of characters contained in the command name:</li>

\[ \text{curcs}=\texttt{hashfunction}\text{(Unicode UTF-8 string of characters in command name)}\]

<li>calculate the command token value where</li> 
   
\[ \text{command token} = \text{curcs} + 2^{29} - 1\]

</ol>
<h5><span class="mw-headline" id="Examples_2">Examples</span></h5>
<ul>
<li>for the <code>\\</code> command (a control symbol), LuaTeX calculates \(\text{curcs}=94\), resulting in a token value for <code>\\</code> of \(94 + 2^{29} - 1 = 536871005\).</li>

<li>for the <code>\vskip</code> primitive command (a control word) LuaTeX calculates  \(\text{curcs}=3560\), resulting in a token value for <code>\vskip</code> of \(3560 + 2^{29} -1 = 536874471\).</li>

<li>for the user-defined macro <code>\mynewmacro</code> (a control word) LuaTeX calculates \(\text{curcs} = 2971\), resulting in a token value for <code>\mynewmacro</code> of \(2971 + 2^{29} -1 = 536873882\).</li>
</ul>
<p>Once created, tokens may be stored for later use via so-called <em>token lists</em> or they can be immediately passed on for further processing inside the TeX engine. Using integer values to represent tokens not only works across all types of computing platform/operating system but it is also a very efficient way for TeX to store/process data.</p>
<h3><span id="How_a_TeX_engine_identifies_the_type_of_token_.28command_or_character.29"></span><span class="mw-headline" id="How_a_TeX_engine_identifies_the_type_of_token_(command_or_character)">How a TeX engine identifies the type of token (command or character)</span></h3>
<p>Given a particular integer token value, \(T\), a TeX engine can easily determine if \(T\) represents a command or a character by testing if \(T\) exceeds a certain \(\text{threshold value}\)—that \(\text{threshold value}\) depends on the TeX engine. If \(T \geq \text{threshold value}\) then \(T\) is a command token otherwise \(T\) is a character token. The \(\text{threshold value}\) is \(4095\) for 8-bit engines and \(2^{29}-1\) (536,870,911)  for LuaTeX. Knuth designed the methods used in token-calculation formulae so that his TeX engine, and all subsequent engines based on his code/architecture, can quickly and easily test token values.</p>
<h2><span id="Tokens_can_be_broken_apart_.28and_converted_back_to_text.29"></span><span class="mw-headline" id="Tokens_can_be_broken_apart_(and_converted_back_to_text)">Tokens can be broken apart (and converted back to text)</span></h2>
<p>Tokens (integers) are the mechanism through which a TeX engine “encapsulates” everything it needs to record about an item of input (character or command). However, there are times when a TeX engine needs to reverse the tokenization process—to find out what was originally read-in to produce that token value—an individual character or a sequence of one or more characters forming the name of a command:</p>
<ul>
<li><strong>for character tokens</strong>: Any character token can be split into its two constituent parts: the character code and corresponding category code assigned to that character <em>at the point it was originally read-in</em>. Like all TeX engines, LuaTeX will not change that original category code allocation but will make use of it during further internal processing activities.</li>

<li><strong>for command tokens:</strong> These are slightly more detailed but if you look at LuaTeX’s calculation of command tokens, including tokens for active characters, you see they follow a pattern:</li>

\[\text{command token} = \text{curcs} + 2^{29} -1\]

<p>where \(\text{curcs}\) is calculated according to the type of command token being generated: active character, control symbol or control word. The \(\text{curcs}\) variable is an <em>extremely</em> important component of a TeX engine’s inner operations: given any command token (integer) value LuaTeX can very easily extract the value of \(\text{curcs}\) from that command token using \(\text{curcs} = \text{token value} - (2^{29} -1)\).</p>

</ul>
<h3><span id="Why_is_.5C.28.5Ctext.7Bcurcs.7D.5C.29_so_important.3F"></span><span class="mw-headline" id="Why_is_\(\text{curcs}\)_so_important?">Why is \(\text{curcs}\) <em>so important</em>?</span></h3>
<p>The internal TeX variable \(\text{curcs}\) (<strong>cur</strong>rent <strong>c</strong>ontrol <strong>s</strong>equence) is a vitally important component of a TeX engine’s inner “under the hood” operations. Although you won’t, and cannot, use or access it directly in your code, \(\text{curcs}\) plays a crucial role because TeX engines use the current value of \(\text{curcs}\) as an index into internal tables which store data about every command currently known to the engine. Those tables store information about the current meaning of a command: what does it do, or represent and, in addition, they record the sequence of characters originally used to calculate that \(\text{curcs}\) value. By extracting the value of \(\text{curcs}\) from a command token, a TeX engine is able to determine the name, i.e., human-readable text, corresponding to any (command) token, enabling it to perform the token-to-text conversions which are a key aspect of <code>\directlua</code>’s operation.</p>
<h3><span id="Converting_integer_tokens_back_to_characters_or_character_sequences_.28command_names.29"></span><span class="mw-headline" id="Converting_integer_tokens_back_to_characters_or_character_sequences_(command_names)">Converting integer tokens back to characters or character sequences (command names)</span></h3>
<p>We’ve seen that TeX engines convert input characters, or character sequences, to integer token values but there are occasions when a TeX engine needs to <em>reverse</em> that process—to output the human-readable text originally used to create those integer token values; for instance:</p>
<ul>
<li>writing error or warning messages to the screen or <code>.log</code> file;</li>
<li>outputting TeX/LaTeX code to a text file via the <code>\write</code> command;</li>
<li>when converting a sequence of tokens to text within <code>\directlua</code> (as we’ll soon see!)</li>
</ul>
<h4><span class="mw-headline" id="Converting_character_tokens_to_text">Converting character tokens to text</span></h4>
<p>As noted, tokens for non-active characters are calculated using an input character’s category code and character code (Unicode value). LuaTeX uses the formula:</p>
<p>\[ \text{character token} = (2^{21} \times \text{category code}) + (\text{Unicode value})\]</p>
<p>It is a straightforward programming task to split the integer \(\text{character token}\) value to obtain its constituent character code (\(\text{Unicode value}\)) and \(\text{category code}\).</p>
<h4><span class="mw-headline" id="Converting_command_tokens_to_text">Converting command tokens to text</span></h4>
<p>All TeX engines store the name (sequence of characters) of every command they “know about”: whether that command is a user-defined macro or a built-in primitive—the storage of primitive-command names takes place when the TeX engine starts-up, long before it begins to process your code. For user-defined commands (macros), the name of that macro (minus the leading <code>\</code>) is stored away as part of the macro-definition processes inside TeX engines.</p>
<p>When a TeX engine needs to access or output the human-readable text from which an integer command token was originally calculated, it will first determine the \(\text{curcs}\) value for that token; in LuaTeX, \(\text{curcs} = \text{token} - (2^{29} -1\)). Using the value of \(\text{curcs}\) extracted from a command token, a TeX engine can access an internal data structure called the <em>string pool</em> to determine the sequence of human-readable characters originally used to calculate that particular value for \(\text{curcs}\) and, consequently, the corresponding command token.</p>
<p>As we’ll see, these token-processing activities—converting character sequences to integer token values and  converting integer token values back to character sequences (“de-tokenization”)—are the <em>fundamental mechanisms</em> used inside <code>\directlua</code>.</p>
<h2><span class="mw-headline" id="Token_lists">Token lists</span></h2>
<p>As a TeX engine is reading input, generating character and command tokens (and processing them),  it might encounter certain commands which instruct the engine to (temporarily) stop passing tokens onward for further processing but, instead, store them away for later use. The most common example is defining a macro using one of the macro-definition commands <code>\def</code>, <code>\edef</code>, <code>\gdef</code> or <code>\xdef</code>—LaTeX commands such as <code>\newcommand</code> are macros that provide additional functionality constructed around low-level primitives which, eventually, perform the actual macro-definition process. A macro can be considered as the name given to a particular list of stored tokens: a token list.</p>
<p class="mw-empty-elt"></p><p>TeX engines make <em>extensive</em> use of token lists, especially <a href="../How_does_/expandafter_work__TeX_uses_temporary_token_lists.html">temporary internal-only lists</a> used for internal processing purposes. Every TeX engine also provides user-level commands to create token lists that are stored away for when the user, or the TeX engine itself, requires them. The number of token-list-creation commands (built-in primitives) varies according to the TeX engine but they all share a core minimum set supported by every engine, such as the <code>\toks</code> primitive.</p>
<p class="mw-empty-elt"></p><p class="mw-empty-elt"></p><p>In practice, a token list is just a stored sequence of integer values: 
   </p><ul>
      
      <li>the input is read to generate (calculate) individual tokens, representing a character or command;</li>
 <li>each token is then stored away, preserving the sequence in which tokens were generated from the input.</li>
   </ul>

<p>TeX engines store token lists using a data structure called a <a href="https://en.wikipedia.org/wiki/Linked_list">linked list</a> (the singly-linked variety). Readers wishing to know more on token lists are invited to read the Overleaf article <a href="../What_is_a_TeX_token_list.html">What is a TeX token list?</a> which uses an analogy to construct the concepts/ideas behind a token list. An in-depth exploration of TeX’s token lists, and how they are used in macro processing,  can be found in the Overleaf article series <a href="../../A_six-part_series__How_do_TeX_macros_actually_work_.html">How do TeX macros actually work?</a></p>
<p class="mw-empty-elt"></p>
<h4><span class="mw-headline" id="A_token_list_in_graphic_form">A token list in graphic form</span></h4>
<p>The following graphic shows a LuaTeX-generated token list with corresponding token values produced from the following input</p>
<p><code>Hi, \TeX! \hskip 5bp</code></p>
<p>For example, if we define <code>\mymacro</code> as <code>\def\mymacro{Hi, \TeX! \hskip 5bp}</code> the definition of <code>\mymacro</code> would be stored in memory using a token list such as this:</p>
<p class="mw-empty-elt">
   </p><p><img src="https://images.ctfassets.net/nrgyaltdicpt/3DRjCN8AL5r4uGKjWlCc87/9900d8efe53d880eb8804f138eab7019/list_schematic--plain2.svg" /></p>

<p class="mw-empty-elt"></p><p class="mw-empty-elt">
   </p><p>The token list is a sequence of linked items called <em>nodes</em>, the name given to a small package of LuaTeX’s memory allocated to hold each item in the list (like individual links in a chain). Each node contains an integer token value and memory address of the <em>next</em> node in the chain, forming a data structure called a <a href="https://en.wikipedia.org/wiki/Linked_list">linked list</a>. The last node indicates the end of the list using a special “null value” for the next node—because there isn’t one.</p>

<p class="mw-empty-elt"></p>
<p><strong>Notes: </strong></p>
   <ul>
<li>   For convenience, we have included the address of each individual node but, in practice, that data isn’t stored within token-list nodes; only the address of the <em>next node</em> is required to build TeX engine token lists.</li>
   <li>The second column in the graphic titled “What each token means” shows a series of grey boxes containing information on the token contained in each node: these are purely for information and <em>do not</em> form part of the actual data stored in the token list.</li>
</ul>
<p>Here is a table of the token values contained in the token list depicted above:</p>
<table>
  <tbody><tr>
   <td><strong>Input item</strong>
   </td>
   <td><strong>Type of input</strong>
   </td>
   <td><strong>Category code <br />
</strong><p><strong>(if character)</strong>
</p>
   </td>
   <td><strong>Token value</strong>
   </td>
  </tr>
  <tr>
   <td>H
   </td>
   <td>character
   </td>
   <td>11
   </td>
   <td>23068744
   </td>
  </tr>
  <tr>
   <td>i
   </td>
   <td>character
   </td>
   <td>11
   </td>
   <td>23068777
   </td>
  </tr>
  <tr>
   <td>,
   </td>
   <td>character
   </td>
   <td>12
   </td>
   <td>25165868
   </td>
  </tr>
  <tr>
   <td>&lt;space&gt;
   </td>
   <td>character
   </td>
   <td>10
   </td>
   <td>20971552
   </td>
  </tr>
  <tr>
   <td>\TeX
   </td>
   <td>command (macro)
   </td>
   <td>
   </td>
   <td>536871539
   </td>
  </tr>
  <tr>
   <td>!
   </td>
   <td>character
   </td>
   <td>12
   </td>
   <td>25165857
   </td>
  </tr>
  <tr>
   <td>&lt;space&gt;
   </td>
   <td>character
   </td>
   <td>10
   </td>
   <td>20971552
   </td>
  </tr>
  <tr>
   <td>\hskip
   </td>
   <td>command (primitive)
   </td>
   <td>
   </td>
   <td>536874247
   </td>
  </tr>
  <tr>
   <td>5
   </td>
   <td>character
   </td>
   <td>12
   </td>
   <td>25165877
   </td>
  </tr>
  <tr>
   <td>b
   </td>
   <td>character
   </td>
   <td>11
   </td>
   <td>23068770
   </td>
  </tr>
  <tr>
   <td>p
   </td>
   <td>character
   </td>
   <td>11
   </td>
   <td>23068784
   </td>
  </tr>
</tbody></table>
<p><strong>Note:</strong> Our original input text has a &lt;space&gt; after the <code>\hskip</code> command but there is no token representing that &lt;space&gt; character in the token list. That &lt;space&gt; character was absorbed by LuaTeX’s input-scanning (reading) process because it was used to terminate LuaTeX’s search for characters comprising the <code>\hskip</code> command.</p>
<h2><span id="How_.5Cdirectlua_really_works"></span><span class="mw-headline" id="How_\directlua_really_works">How \directlua really works</span></h2>
<p>Now that we have explored tokens, token lists and converting tokens-to-text, the next challenge is to understand the TeX-engine concept of token <em>expansion</em>.</p>
<p>As noted, <code>\directlua{⟨code⟩}</code> can be asked to process <code>⟨code⟩</code> which contains both Lua and TeX/LaTeX code but LuaTeX’s in-built Lua language interpreter doesn’t understand TeX or LaTeX: so how can this work? How is it possible for the <code>⟨code⟩</code> to contain TeX/LaTeX instructions without thoroughly confusing the Lua interpreter with commands it does not understand? For example, the following <code>\directlua</code> command only uses TeX macros, but it works:</p>
<pre>\def\aa{tex}
\def\bb{.}
\def\cc{print}
\def\dd{("Hello")}
\directlua{
   \aa\bb\cc\dd
}
</pre>
<p>This <code>\directlua</code> command results in LuaTeX typesetting <code>Hello</code> but why and how does this work because the Lua language does not understand TeX macros?</p>
<p class="mw-empty-elt"></p><p>The answer is contained within the earlier description we borrowed from the <a href="http://www.pragma-ade.com/general/manuals/luatex.pdf">LuaTeX Reference Manual</a> but we can consider that <code>\directlua{⟨code⟩}</code> works by LuaTeX initially “pre-processing” the <code>⟨code⟩</code> before anything is passed to the Lua interpreter. The nature of this “pre-processing”—i.e., what it really means and its consequences for your <code>⟨code⟩</code>—is the next topic we’ll address to help readers interested to take advantage of the power and flexibility of <code>\directlua</code>.</p>
<p class="mw-empty-elt"></p>
<h3><span id="How_LuaTeX_processes_.5Cdirectlua:_A_first_look"></span><span class="mw-headline" id="How_LuaTeX_processes_\directlua:_A_first_look">How LuaTeX processes <code>\directlua</code>: A first look</span></h3>
<p>To build-out our understanding of <code>\directlua</code>’s “pre-processing” activities we can start with the following simplified diagram which gives an overview of what happens. The <code>⟨code⟩</code> provided to <code>\directlua{⟨code⟩}</code> is first converted to tokens using the processes and calculations discussed above; that sequence of tokens is stored in a token list. Once that token list has been built, each token in that list is converted back to its textual representation: the text produced by every token—character token or command token—is combined (concatenated) to create a single string of code passed on to the Lua interpreter for execution.</p>
<p class="mw-empty-elt"></p><p><img src="https://images.ctfassets.net/nrgyaltdicpt/1aq6zBld5wwFynP0UDXNm9/6c8134952ff14e7eacf82606bfa448eb/processing_code--minimal--plain.svg" /></p>
<p class="mw-empty-elt"></p>
<p>But wait, what would be the point of going from text to tokens and converting those tokens straight back into text? You might not be surprised to learn that, yes, there is an additional and vital process that we haven’t included in this graphic: <em>token expansion</em>. Every token produced from the text in your <code>⟨code⟩</code> is subjected to a type of “inspection” in which LuaTeX applies a test to see if that token represents a command which belongs to the subset known as <em>expandable commands</em>. If it does, LuaTeX filters-out that command by <em>removing</em> it from your <code>⟨code⟩</code> and <em>replacing it</em> with the result(s) of a process TeX engines call <em>token expansion</em>.</p>
<h3><span id="How_LuaTeX_processes_.5Cdirectlua:_A_second_look_.28at_expansion.29"></span><span class="mw-headline" id="How_LuaTeX_processes_\directlua:_A_second_look_(at_expansion)">How LuaTeX processes \directlua: A second look (at expansion)</span></h3>
<p>TeX’s expansion mechanism is a core component of all TeX-based typesetting engines because, ultimately, each one is derived from (or based on) Knuth’s original source code and design of TeX. However, the concept of expansion is difficult to explain in concise, yet accessible, language because, in practice, expansion is an “umbrella” term used to describe a single process—but one that produces a range of outputs. Those varied outcomes are a consequence of the somewhat eclectic set of commands to which expansion can be applied, so you can consider that each expandable command has a certain “expansion behaviour”.</p>
<p>As a <em>first approximation</em> to understanding expansion we can say that expansion of a token (command) means <em>removing</em> that command (token) from TeX’s current input and <em>replacing</em> it by a sequence of tokens which result from executing that particular expandable command—replacing the original token with the results/consequences of its expansion <em>behaviour</em>. However, this initial “definition” of expansion—in terms of generating new tokens for TeX to read—isn’t totally accurate for all expandable commands, but it is good enough as a starting point.</p>
<p>To give a straightforward example: the TeX primitive <code>\jobname</code> is an expandable command and its <em>expansion</em> is a sequence of character tokens which represent the name of the main TeX input file. If TeX decides to expand a <code>\jobname</code> command (token) it is <em>removed</em> from TeX’s current input source and <em>replaced</em> by the sequence of character tokens it generates—which TeX then proceeds to read/process.</p>
<p>Within <code>\directlua</code>, after an expandable token is processed (removed) and replaced by new tokens, LuaTeX will go on to read those new tokens it has just put in place—but some of those new tokens could also be expandable. Because <code>\directlua</code> performs so-called <em>full expansion</em>, LuaTeX will read those new tokens and, once again, go through the expansion process to expand (remove) any new (expandable) tokens—this expansion process continues until no expandable tokens are left. However, there are two important exceptions to this “keep on expanding” rule, both of which we’ll discuss below:</p>
<ul>
<li>using the construct <code>\the\toks</code>;</li> 
<li>deliberate prevention (suppression) of expansion for one or more selected tokens.</li>
</ul>
<p>As noted, our working definition (first approximation) to understanding expansion doesn’t cover the full range of expansion behaviours demonstrated by the subset of expandable commands. For example, some expandable commands don’t generate tokens in the way that <code>\jobname</code> does, but they might:</p>
<ul>
<li>“filter” tokens from the input: a TeX engine’s conditional commands (<code>\if</code>, <code>\ifcat</code>, <code>\ifnum</code>, <code>\ifdim</code>, <code>\ifodd</code>, <code>\ifvmode</code>, …) are expandable. Their expansion behaviour is a type of “token filtering”—conditionals can be used in <code>\directlua</code>.</li>
<li>“juggle” tokens in the input: the <a href="../A_six-part_article_series_on_/expandafter%2c_TeX_tokens_and_expansion.html"><code>\expandafter</code> command</a> is expandable and changes the sequence in which two tokens are expanded.</li>
<li>prevent expansion: the expandable commands <code>\noexpand</code> and <code>\unexpanded</code> suppress  expansion of command tokens in the input.</li>
<li>convert character sequences in the input to command tokens: <code>\csname … \endcsname.</code></li>
<li>convert internal quantities to a sequence of character tokens: <code>\number</code> and <code>\the</code> are expandable commands which generate a sequence of character tokens representing the value of an internal quantity.</li>
<li>convert command tokens to character tokens: <code>\string</code> and <code>\detokenize</code> are expandable commands which convert their arguments to a sequence of character tokens with category code 12. Note that <code>\detokenize</code> differs from <code>\string</code>: <code>\detokenize</code> can process multiple tokens and it introduces a space character, with category code 10, after processing command tokens created from <em>control words</em>. In effect, <code>\detokenize</code> adds a trailing space-character after the command name—we’ll see some examples later in the article.</li>
</ul>
<h4><span id="Refining_our_.E2.80.9Cdefinition.E2.80.9D_of_expansion"></span><span class="mw-headline" id="Refining_our_“definition”_of_expansion">Refining our “definition” of expansion</span></h4>
<p>We can now generalize our definition to say that expansion of a command (token) involves <em>removal</em> of that command (token) from TeX’s current input source and <em>replacing it</em> with the result of the <em>token operation(s)</em> performed by that command. In essence, the expansion process causes an expandable command to perform some type of “operation” on tokens in TeX’s current input which affects the number, or behaviour, of tokens that TeX will subsequently read—the precise nature of that “operation” depends on which command is being expanded. All macros, and active characters, are expandable but only a small number of a TeX engine’s built-in commands (primitives) are classified as expandable—the list of expandable commands depends on the TeX engine you are using.</p>
<p>Every new TeX engine inherits the primitive commands built into its ancestors(s)—the earlier-generation TeX engine(s) from which it was derived—and some of those inherited primitives will be expandable. Of course, a new TeX engine may choose not to implement some of the primitive commands contained in the earlier engines or to modify their behavior to suit the needs of the new engine. In addition, new TeX engines typically implement additional primitives to provide support for their own enhanced functionality—some of those might also be expandable. Consequently, the number of expandable commands available to you will vary according to the TeX engine you are using—LuaTeX has quite a collection of them.</p>
<p>Another difficulty with explaining/understanding expansion, and perhaps the real challenge, is knowing exactly <em>when</em> a TeX engine is, or is not, actually going to perform the expansion process. That is a large and complex topic because expansion is deeply embedded throughout the inner workings of TeX engines: we don’t have space to address this in any detail beyond the use of expansion in <code>\directlua</code>.</p>
<h3><span id="How_LuaTeX_processes_.5Cdirectlua:_A_final_look"></span><span class="mw-headline" id="How_LuaTeX_processes_\directlua:_A_final_look">How LuaTeX processes <code>\directlua</code>: A final look</span></h3>
<p>The following diagram summarizes the <code>\directlua</code> pre-processing activities which take place inside the LuaTeX engine itself. In this diagram we also show two low-level (internal) LuaTeX functions that actually do the work: <code>scan_toks()</code> and <code>tokenlist_to_cstring()</code>. Those functions are written in the C language and reside deep inside the executable LuaTeX software: they are part of LuaTeX’s inner machinery and not <em>directly</em> accessible to your TeX/LaTeX code.</p>
<p class="mw-empty-elt"></p><p><img src="https://images.ctfassets.net/nrgyaltdicpt/5QsRpvmj70dKsLqJsTGUNn/cc15fbd8117a02cee32af048f5c2c2df/processing_code--full--plain.svg" /></p>
<p class="mw-empty-elt"></p>
<p>The following description of <code>\directlua ⟨code⟩</code>’s pre-processing activity summarizes the diagram above.</p>
<ol>

<li>The sequence of characters in your ⟨code⟩ is processed by <code>scan_toks()</code>. Its purpose is to read your ⟨code⟩ character-by-character to generate character tokens and command tokens. Because it is creating tokens, the category code assigned to each character in ⟨code⟩, at the time it is read-in, is extremely important.</li>

<li>During <code>scan_toks()</code>’s token processing (generation) any expandable command (token) is expanded <em>unless</em> prevented via commands such as <code>\protected</code> (macro definitions), <code>\noexpand</code>, <code>\unexpanded</code> etc. Active characters (category code 13) are also expanded (unless prevented).</li>

<li>The stream of tokens created by <code>scan_toks()</code> is built into one long token list—tokens present in that list incude those produced from expansion being applied to expandable commands (such as macros) present in your <code>⟨code⟩</code>. Note too that <code>scan_toks()</code> <em>does not</em> trigger or cause execution of any token representing a non-expandable command: such non-expandable tokens are simply passed-through to be incorporated into the token list being constructed.</li>

<li>Once the token list is finished and all expansion activity is complete, that token list is processed by another function called <code>tokenlist_to_cstring()</code> which converts each token in the final token list back into its textual representation. This generates a string of text which is the Lua code to be passed on to the Lua interpreter. For successful execution, that string needs to contain syntactically correct Lua code.</li>

<li>Lua’s processing of that code takes place in two steps:</li> 

<ol type="a">
<li>LuaTeX’s built-in Lua interpreter parses and “compiles” the Lua code generated in the previous steps. If that parsing/compilation fails, the Lua interpreter will generate errors (such as syntax errors)—those errors can cause the LuaTeX run to fail unless you chose to use <code>--interaction=nonstopmode</code> on the command line.</li>
<li>If parsing/compilation succeeds, the Lua interpreter executes the code compiled in step (5a).</li> 
</ol>
</ol>
<p>In essence, the <code>scan_toks()</code> function is the core of LuaTeX’s pre-processing activities: its main task is to expand all expandable TeX/LaTeX commands contained in the text of your <code>⟨code⟩</code> and   construct a token list out of everything it has processed. Again, we stress that <code>scan_toks()</code> <em>does not execute non-expandable commands</em> (tokens): it simply <em>stores</em> those tokens in the token list it is constructing. Once completed, that token list is subsequently converted <em>back to a textual representation</em> by <code>tokenlist_to_cstring()</code>—a token list is a TeX-only concept which is completely alien to a Lua interpreter, thus the need to convert it to text, becoming Lua code for passing on to the Lua interpreter.</p>
<h2><span id="Expansion_as_a_programming_language_.E2.80.9Cinterface.E2.80.9D"></span><span class="mw-headline" id="Expansion_as_a_programming_language_“interface”">Expansion as a programming language “interface”</span></h2>
<p>You can think of <code>\directlua</code>’s expansion process being used as a mechanism, or interface, for passing data/information from the “TeX World” across into the “Lua World”: providing a method for the TeX language to communicate data to the Lua language. For example, TeX code such as <code>\number\count75</code> can be used to transfer a “TeX World” value stored in count register 75 across to the “Lua World” integer variable x:</p>
<pre>\count75=1564 % Data existing in the "TeX World"
\directlua{
   local x=\number\count75 \space % Transfer TeX data to the "Lua World"
   tex.print("x= "..x)
   local y = (2*x-65)/5
   tex.print(" and y = "..y)
}
</pre>
<p>This generates the Lua code</p>
<pre> local x=1564 tex.print("x= "..x) local y = (2*x-65)/5 tex.print(" and y = "..y)</pre>
<p><strong>Note</strong>: We added <code>&lt;space&gt;\space</code> after <code>\number\count75</code> to ensure a space character was preserved between <code>1564</code> and <code>tex.print</code>—that’s not strictly necessary here because Lua would still parse the code correctly if we omitted it. The space character following immediately after <code>\count75</code> is absorbed during the process TeX engines use to look for numeric values—here, the value being supplied to <code>\count</code>. The space character after <code>75</code> is used to terminate LuaTeX’s search for digit sequence <code>75</code> and is absorbed from the input. The <code>\space</code> macro expands to provide the space character needed to separate the text <code>1564</code> and <code>tex.print</code>.</p>
<p>Using the code above LuaTeX will typeset</p>
<p><code>x= 1564 and y = 612.6</code></p>
<p>Here, the “data passing” mechanism is achieved by <code>\number</code>: an expandable command which, in this instance, instructs TeX to retrieve the value stored in <code>\count</code> register <code>75</code> and from that value (<code>1546</code>) generate a series of character tokens, one character token for each digit, resulting in a token sequence for the digits <code>1</code>, <code>5</code>, <code>6</code> and <code>4</code>. Those 4 character tokens are incorporated into the main token list being constructed by <code>\directlua</code> and subsequently converted back to their textual representation when the token list is converted to text. It is undoubtedly a very circuitous route going from the <code>\count75</code> register value stored inside LuaTeX, to digits destined for Lua code but, ultimately, it works.</p>
<p><strong>TIP: </strong>If you want to inspect the results of LuaTeX’s expansion activities you can write code like this:</p>
<pre>\directlua{
   local foo=[[local x=\number\count75
   tex.print("x= "..x)
   local y = (2*x-65)/5
   tex.print(" and y = "..y)]]
   print(foo)
}
</pre>
<p>In this example we use the long-brackets method to create a string variable <code>foo</code> whose purpose is to hold the string of Lua code generated from expansion of everything between <code>[[</code> and <code>]]</code>. That string is printed out to the console via the Lua function call <code>print(foo)</code>.</p> 
<p>On Overleaf you can view similar results by writing the contents of <code>foo</code> to the <code>.log</code> file using the LuaTeX Lua function <code>texio.write()</code>:</p>
<pre>\directlua{
   local foo=[[local x=\number\count75
   tex.print("x= "..x)
   local y = (2*x-65)/5
   tex.print(" and y = "..y)]]
   texio.write(foo)
}
</pre>
<h2><span id="Tokens_in_the_.5Cdirectlua_token_list:_non-expandable_tokens_and_unexpanded_tokens"></span><span class="mw-headline" id="Tokens_in_the_\directlua_token_list:_non-expandable_tokens_and_unexpanded_tokens">Tokens in the <code>\directlua</code> token list: <em>non-expandable</em> tokens and <em>unexpanded</em> tokens</span></h2>
<p>We’ve noted that <code>\directlua{⟨code⟩}</code>  performs <em>full expansion</em> of your <code>⟨code⟩</code>: it removes and expands all expandable commands until only non-expandable tokens are left. The sequence of tokens created by <code>\directlua</code>’s processing (in the <code>scan_toks()</code> function) are strung together to form a token list whose individual tokens will be converted back to text for passing on to Lua.</p>
<p>However, we’ve not yet addressed the final part of this story because we need to consider the two “classes” of command token which can make it through to the token list being built within <code>\directlua</code>: we’ll refer to them as <em>shorthand command tokens</em> and <em>unexpanded</em> tokens:</p>
<ul>
<li><strong>shorthand command tokens</strong>: This type of command token arises from control sequences defined using one of the TeX primitives <code>\chardef</code>, <code>\mathchardef</code>, <code>\countdef</code>, <code>\dimendef</code>, <code>\skipdef</code>, <code>\muskipdef</code> and <code>\toksdef</code>. These primitive commands are used to define control sequences which represent a numeric value—the resulting control sequences are <em>not</em> expandable.</li>

<li><strong>unexpanded tokens</strong>: This token type arises from commands that would normally be expanded but <code>\directlua</code> has either:</li>
<ul>
<li>been explicitly instructed <em>not</em> to expand them; for example, suppression of expansion by the commands <code>\noexpand</code> or <code>\unexpanded</code>—we’ll explain shortly how this is done;</li>
<li>injected tokens by processing the sequence <code>\the\toks</code> (more on that below).</li>
</ul>
</ul>
<h3><span id="Two_.E2.80.9Cgroups.E2.80.9D_of_token_in_a_.5Cdirectlua_token_list"></span><span class="mw-headline" id="Two_“groups”_of_token_in_a_\directlua_token_list">Two “groups” of token in a \directlua token list</span></h3>
<p>Based on our discussions, we can say that tokens contained in the token list being constructed during the first stage of <code>\directlua</code>’s pre-processing (in the <code>scan_toks()</code> function) fall into two groups:</p>
<ol>
<li><em>inherently non-expandable</em> tokens</li> 
<ul>
<li>any token representing a non-active <em>character</em>;</li>
 <li>any token representing a non-expandable <em>primitive</em> <em>command</em>;</li>
 <li>any token representing a <em>shorthand command</em> (these are not expandable, see below).</li>
</ul>
<li><em>unexpanded</em> tokens:</li> 
<ul>
<li>any token representing an expandable command whose expansion was <em>suppressed </em> (or avoided)<em> </em>during <code>\directlua</code>’s pre-processing.</li> 
</ul>
</ol>
<h4><span class="mw-headline" id="Shorthand_command_tokens:_creating_non-expandable_commands">Shorthand command tokens: creating non-expandable commands</span></h4>
<p>As noted, TeX engines provide a set of primitives (built-in commands) that can be used to construct <em>non-expandable</em> control sequences (indicated here by <code>⟨command⟩</code>). These primitives take the form:
</p>
<ul>
   <li><code>\chardef ⟨command⟩ = ⟨numeric value⟩ </code></li>
   <li><code>\mathchardef ⟨command⟩ = ⟨numeric value⟩</code></li>
   <li><code>\countdef ⟨command⟩ = ⟨numeric value⟩</code></li>
   <li><code>\dimendef ⟨command⟩ = ⟨numeric value⟩</code></li> 
   <li><code>\skipdef ⟨command⟩ = ⟨numeric value⟩</code></li>
   <li><code>\muskipdef ⟨command⟩ = ⟨numeric value⟩</code></li>
   <li><code>\toksdef ⟨command⟩ = ⟨numeric value⟩</code></li> 
</ul>
<p>where <code>⟨numeric value⟩</code> is some integer value appropriate to each command.</p> 
   <p>Here, we’ll briefly review the use of <code>\chardef</code> to demonstrate the key feature of these primitives—producing a <code>⟨command⟩</code> that is non-expandable. You can use <code>\chardef\mydollar=`\$</code> to create the control sequence <code>\mydollar</code> and use it to typeset a <code>$</code>:</p> 
<p><code>I paid \mydollar30.</code></p> 
<p>This will typeset <code>I paid $30.</code> The control sequence <code>\mydollar</code> created by <code>\chardef</code> is not expandable, as we can see from the following example:</p>
<pre>\chardef\mydollar=`\$
\directlua{
   local x =[[I paid \mydollar30.]] 
   texio.write(x)
}
</pre>
<p>Which produces the following text in the <code>.log</code> file</p>
<p><code>I paid \mydollar 30.</code></p>
<p>This shows <code>\mydollar</code> was <em>not</em> expanded during <code>\directlua</code>’s pre-processing. The space appearing after <code>\mydollar</code> is added when a command token is converted to its representation as text.</p>
<p>When you use <code>\chardef</code> to create a control sequence, TeX’s internal classification of that control sequence (command) results in it being <em>non-expandable</em> which is very different behaviour compared to control sequences defined by one of the macro-definition commands: \def, \edef, \gdef or \xdef. As noted above, during the process of constructing its token list <code>\directlua</code> examines each incoming command token to check for expandability. If a command token is not expandable, it passes straight through to the token list and its text representation will later reappear in the string of Lua code resulting from conversion of tokens in the token list back into their textual form.</p>
<h5><span class="mw-headline" id="Brief_notes_on_plain_TeX_vs._LaTeX">Brief notes on plain TeX vs. LaTeX</span></h5>
<p>Historically, Knuth’s original plain TeX defined the commonly-used control symbols <code>\%</code>, <code>\&amp;</code>, <code>\#</code> and <code>\$</code> using <code>\chardef</code>—not using one of the standard macro-definition commands <code>\def</code>, <code>\edef</code>, <code>\gdef</code> or <code>\xdef</code>. For example:</p>
<pre>   \chardef\#=`\#
   \chardef\$=`\$
   \chardef\%=`\%
   \chardef\&amp;=`\&amp;
</pre> 
<p>The strange <code>`\</code> syntax is a TeX method to get the numeric character code value. In the old plain TeX regime, these control symbols are not expandable (due to <code>\chardef</code>) but LaTeX (or packages) may redefine of them as <em>macros</em> to provide enhanced functionality—that would make them expandable, so you may need to be aware of this.</p>
<h5><span id="How_does_this_affect_.5Cdirectlua.3F"></span><span class="mw-headline" id="How_does_this_affect_\directlua?">How does this affect <code>\directlua</code>?</span></h5>
<p>Let’s compare the result of the following code run under plain TeX and LaTeX. For simplicity we’ll write the results to the <code>.log</code> file using the LuaTeX Lua API function <code>texio.write()</code>.</p>
<pre>\directlua{
   local x=[[\$150 for the "\#1" product---20\%! more than its competitor, Widget \&amp; Co.]]
   texio.write(x)
}
</pre>
<p>Running this code using <strong>plain TeX</strong> produces the following output in the <code>.log</code> file, showing the result of any expansions:</p>
<pre>\$150 for the "\#1" product---20\%! more than its competitor, Widget \&amp; Co.</pre>
<p>Clearly, under plain TeX none of the control symbols<code>\$</code>, <code>\#</code>, <code>\%</code> or <code>\&amp;</code> were expanded—because they are all created using <code>\chardef</code>.</p>
<p>Running that code using the <strong>LaTeX</strong> document:</p>
<pre>\documentclass{article}
\begin{document}
   \directlua{local x=[[\$150 for the "\#1" product---20\%! more than its competitor, Widget \&amp; Co.]] texio.write(x)}
\end{document}
</pre>
<p>produces the following output in the <code>.log</code> file </p>
<pre>\protect \TU\textdollar 150 for the "\#1" product---20\%! more than its competitor, Widget \&amp; Co.
</pre>
<p>Clearly, running LaTeX generates a result different to plain TeX because under LaTeX the command <code>\$</code> has been expanded, indicating it is a macro.</p>
<p><strong>Note: </strong> In both plain TeX and LaTeX <code>\directlua</code> did not fully process any of the control symbols <code>\%</code>, <code>\&amp;</code>, <code>\#</code> and <code>\$</code> to generate the corresponding character. During the expansion process performed by <code>\directlua</code> the tokens representing these control symbols—or, for LaTeX, their expansion—pass straight through to the main token list being constructed.</p>
<p><strong>Note:</strong> Control symbols are formed from a single character not of category code 11, such as <code>\#</code>. When a token representing a control symbol is converted back to its textual representation TeX engines do not insert a space character after that text. This special treatment of control symbols is a built-in rule for how TeX engines operate.</p>
<h3><span class="mw-headline" id="Unexpanded_tokens:_suppressing_expansion">Unexpanded tokens: suppressing expansion</span></h3>
<p><code>\directlua</code>’s pre-processing is one example where a TeX engine is performing expansion but you might want to <em>prevent</em> expansion being applied to one or more tokens that would otherwise be expanded. By way of another example, LuaTeX (and all TeX engines) perform an expansion process, similiar to that of <code>\directlua</code>, when they process the <code>\write</code> command:</p>
<p><code>\write file-number {⟨material⟩}</code></p>
<p>\write instructs a TeX engine to output <code>⟨material⟩</code>—often containing TeX/LaTeX commands—to a text file (<code>file-number</code>); any expandable commands within <code>⟨material⟩</code> will, unless prevented, be expanded before <code>⟨material⟩</code> is actually written-out to that file.</p>
<p>As you might expect, TeX engines provide commands to suppress or control expansion:</p>
<ul>
<li><code>\noexpand⟨token⟩</code>: prevents expansion of the single <code>⟨token⟩</code>;</li> 
<li><code>\unexpanded{⟨material⟩}</code>: prevents expansion of all expandable commands (tokens) in <code>⟨material⟩</code>. It is, in effect, a multi-token version of <code>\noexpand</code>;</li>
<li><code>\protected</code>: a prefix added to macro definitions which prevents expansion of that macro in certain circumstances (such as during <code>\directlua</code>, <code>\write</code> or <code>\edef</code>).</li>
</ul>
<p>Despite names which suggest otherwise, both <code>\noexpand</code> and <code>\unexpanded</code> are <em>expandable commands</em> and provide good examples of seeing a TeX engine’s expansion process as performing “token operations”: the operation here is to prevent expansion of one or more subsequent tokens (commands). Because <code>\noexpand</code> and <code>\unexpanded</code> are both expandable commands they are removed and processed (executed) during <code>\directlua</code>’s pre-processing as it constructs the token list from your <code>⟨code⟩</code>.</p>
<h4><span id=".5Cnoexpand_.E2.9F.A8token.E2.9F.A9"></span><span class="mw-headline" id="\noexpand_⟨token⟩"><code>\noexpand ⟨token⟩</code></span></h4>
<p><code>\noexpand ⟨token⟩</code> prevents expansion of the single <code>⟨token⟩</code>. <code>\noexpand</code> within <code>\directlua</code> will be expanded (removed from the input) and replaced by the results of its “expansion behaviour”. The result of expanding <code>\noexpand</code> is to create a special (hidden) <code>⟨marker token⟩</code> that is placed in front of the original <code>⟨token⟩</code> whose expansion is to be suppressed: that <code>⟨marker token⟩</code> acts as a flag saying “do not expand the next token”. Because <code>\directlua</code> is performing full expansion it will re-process any tokens which result from the “expansion behaviour” of an expandable command. Consequently, when the expansion of <code>\noexpand ⟨token⟩</code> is complete, LuaTeX goes back to read the results and sees the two-token sequence  <code>⟨marker token⟩⟨token⟩</code> which causes the original <code>⟨token⟩</code> to pass through, unexpanded, into the token list being constructed by <code>\directlua</code>.</p>
<h5><span class="mw-headline" id="Example">Example</span></h5>
<p>If we write</p>
<pre>\directlua{
   local x= "\TeX"
}</pre>
<p>the <code>\TeX</code> macro is expanded into it constituent tokens which, in plain TeX, will result in the following text being passed to Lua (note: Lua cannot process this code, it’s just an example to demonstrate the process):
</p>
<p><code>local x = "T\kern -.1667em\lower .5ex\hbox {E}\kern -.125emX"</code></p>
<p>If we <em>suppress</em> expansion of the <code>\TeX</code> macro using <code>\noexpand</code></p>
<p><code>\directlua{local x= "\noexpand\TeX"}</code></p>
<p>the following Lua code is produced (again, Lua can’t run this code; it is simply an example to demonstrate <code>\noexpand</code>):</p>
<p><code>local x= "\TeX "</code></p>
<p>Because of <code>\noexpand</code>, <code>\directlua</code> will not expand <code>\TeX</code> but simply allow the token value representing the <code>\TeX</code> command to pass through, unscathed, into the token list being built during the first stage of <code>\directlua</code>’s pre-processing.</p>
<p><strong>Note:</strong> The space character appearing after <code>\TeX</code> is introduced by LuaTeX’s subsequent conversion of the <code>\TeX</code> integer token nalue back to its textual representation (within the <code>tokenlist_to_cstring()</code> function).</p>
<h4><span id=".5Cunexpanded.7B.E2.9F.A8material.E2.9F.A9.7D"></span><span class="mw-headline" id="\unexpanded{⟨material⟩}"><code>\unexpanded{⟨material⟩}</code></span></h4>
<p><code>\unexpanded</code> is an expandable command which suppresses expansion of all tokens formed from <code>⟨material⟩</code>. As we have noted, when a TeX engine performs expansion any expandable command is <em>removed</em> from the input and <em>replaced</em> by the results of its “expansion behaviour”; so what does that actually mean for <code>\unexpanded</code>? Usually, during <em>full expansion</em>, once the expansion process for a particular command is completed the TeX engine goes on to read/process any tokens arising from that command’s “expansion behaviour”—it needs to further expand any tokens that were produced. However, <code>\unexpanded</code> <em>bypasses</em> any further expansion: here is how it does that.</p> 
<p>Inside the TeX engine, the <code>\unexpanded</code> command first converts the characters and commands in <code>⟨material⟩</code> to a temporary token list comprised of <em>unexpanded</em> tokens. After all tokens have been created and stored in that temporary token list, the <code>\unexpanded</code> command causes <code>\directlua</code> to <em>skip</em> going back to read and process them—even though \directlua is performing full expansion. Instead, those <em>unexpanded</em> tokens pass straight through and become incorporated into the main token list being built by <code>\directlua</code> (in the <code>scan_toks()</code> function). In this way, everything in <code>⟨material⟩</code> is converted to tokens and the expansion process is skipped for that set of tokens. The operation of <code>\unexpanded{⟨material⟩}</code> is similar to the use of <code>\the\toks</code>, which we discuss below.</p>
<h5><span class="mw-headline" id="Example_2">Example</span></h5>
<p><code>\unexpanded</code> produces results in a manner similar to <code>\noexpand</code> except it can prevent expansion of multiple tokens; here is an example:</p>
<pre>\directlua{
   local x = "\unexpanded{\foo\bar\foobar}. But Lua can't process this code!"
}
</pre>
<p>which produces the following text as code for Lua:</p>
<p><code>local x = "\foo \bar \foobar . But Lua can't process this code!"</code></p>
<p><strong>Note</strong>: There are space characters after each command name. These are again a consequence of LuaTeX’s subsequent conversion of the unexpanded tokens <code>\foo</code>, <code>\bar</code> and <code>\foobar</code> back to text within the <code>tokenlist_to_cstring()</code> function.</p>
<h4><span id=".5Cprotected_macro_definitions"></span><span class="mw-headline" id="\protected_macro_definitions"><code>\protected</code> macro definitions</span></h4>
<p>The <code>\protected</code> command is a prefix applied to a macro definition to prevent that macro being expanded when TeX is building an expanded token list, such as the token list built by <code>\directlua</code>’s pre-processing. 

</p><h5><span class="mw-headline" id="Example_3">Example</span></h5><p>
Suppose you define the following macros with and without using the <code>\protected</code> prefix:</p><p class="mw-empty-elt"></p>
<pre>\def\macroA{"This unprotected macro contains a string"}
\protected\def\macroB{"This protected macro also contains a string"}
</pre>
<p>If you use Lua’s string concatenation operator (<code>..</code>) to write</p>
<pre>\directlua{
   local x=\macroA..\macroB
}</pre>
<p><code>\directlua</code>’s pre-processing would produce the following code for passing to Lua:</p>
<p>
<code>local x="This unprotected macro contains a string"..\macroB </code>
</p>
<p><code>\macroA</code> is not defined using <code>\protected</code> so it is expanded, producing the first part of the string to be concatenated, but <code>\macroB</code> is defined using <code>\protected</code> so it has not been expanded.</p>
<p>During pre-processing, LuaTeX’s <code>scan_toks()</code> function created a token for <code>\macroA</code>, recognized it was a regular expandable command and expanded it: that expansion produces a sequence of character tokens, one character token for each character in <code>"This unprotected macro contains a string"</code>. Each character token is passed on and added to the token list being built.</p>
<p>When <code>scan_toks()</code> creates the token for <code>\macroB</code> it notices that command was defined as <code>\protected</code> and does not expand it: the token representing <code>\macroB</code> passes through, untouched (not expanded), into the token list being built. After that token list has been built, the next stage of pre-processing, within the <code>tokenlist_to_cstring()</code> function, is to convert all tokens in the token list back to their textual representation. The unexpanded token representing <code>\macroB</code> is detected and converted to its text representation, resulting in the text <code>\macroB</code> appearing in the code destined for Lua. Note that Lua cannot actually concatenate <code>"This unprotected macro contains a string"..\macroB</code> to produce the final string because <code>\macroB</code> has no meaning in Lua’s syntax, resulting in the error <code>unexpected symbol near '\'</code>.</p>
<p><strong>Trivia</strong>: The <code>\protected</code> command was introduced by \(\varepsilon\text{-}\mathrm{\TeX}\), the first major extension of Knuth’s original TeX software, and is supported by all TeX engines whose code ancestry includes \(\varepsilon\text{-}\mathrm{\TeX}\).</p>
<h3><span id="Unexpanded_tokens:_Using_.5Cthe.5Ctoks_in_.5Cdirectlua"></span><span class="mw-headline" id="Unexpanded_tokens:_Using_\the\toks_in_\directlua">Unexpanded tokens: Using <code>\the\toks</code> in <code>\directlua</code></span></h3>
<p>Life in programming would not be the same without those “special cases” to deal with and use of <code>\the</code> in conjunction with <code>\toks</code> in a <code>\directlua</code> command is one such special case.</p>
<h4><span id="Brief_background_on_.5Ctoks"></span><span class="mw-headline" id="Brief_background_on_\toks">Brief background on <code>\toks</code></span></h4>
<p>The TeX primitive <code>\toks</code> instructs a TeX engine to save some tokens for use later on: instead of being passed on for further processing, those tokens are put to one side and stored away in a memory location specified using a <em>token register</em>. For example, we can tell a TeX engine to create some tokens and store them in token register location <code>100</code> using</p>
<p><code>\toks100={Hi, \TeX! \hskip 5bp}</code></p>
<p>Here, TeX uses token register <code>100</code> to access a known location inside its memory: a storage area designated for holding lists of tokens.</p>
<p>Tokens representing everything between the <code>{</code> and <code>}</code> are created, <em>but not expanded</em>, and strung together in a token list—similar to the token list we explored earlier in this article. To re-use those tokens we would write <code>\the\toks100</code> in which <code>\the</code> (an expandable command) instructs TeX to fetch the stored tokens and insert them at the location where you wrote <code>\the\toks100</code>. Another way to think of this is <code>\the\toks</code> causes TeX to insert some tokens at that location.</p>
<p>The <code>\toks</code> command <em>does not expand</em> any of the tokens it is asked to create and save: it simply converts characters and commands between <code>{</code> and <code>}</code> to tokens and stores them.</p>
<h4><span id="Back_to_.5Cdirectlua"></span><span class="mw-headline" id="Back_to_\directlua">Back to <code>\directlua</code></span></h4>
<p>In the discussion of expansion we noted <code>\directlua{⟨code⟩}</code> performs <em>full expansion</em> of <code>⟨code⟩</code>: removing all expandable commands and replacing them with the result of their expansion behaviour—continuing to <em>further expand</em> any tokens arising from the inital expansion of an expandable command.</p>
<p><code>\the</code> is an expandable command so <code>\directlua</code> will expand it; however, when <code>\the</code> is used in conjunction with <code>\toks</code> within <code>\directlua</code>, as in <code>\the\toks⟨token register⟩</code>, the inserted tokens are <em>not expanded any further</em>. Expansion of <code>\the\toks⟨token register⟩</code> injects the sequence of <em>unexpanded</em> tokens, stored in  <code>⟨token register⟩</code>, directly into the token list being constructed by <code>\directlua</code>: this behaviour bypasses the usual process of full expansion. In effect, those tokens pass through, <em>unexpanded</em>, to become incorporated into the main token list being constructed by <code>\directlua</code>—this pass-through process for unexpanded tokens is similar in operation to <code>\unexpanded</code>, as discussed earlier.</p>
<h5><span class="mw-headline" id="Example_4">Example</span></h5>
<p>Suppose we define the macro <code>\mymacro</code> as <code>\def\mymacro{\TeX}</code>. It contains just one token for the <code>\TeX</code> command (which is a macro): so we have an expandable command <code>\mymacro</code> that contains another macro <code>\TeX</code>, which is also expandable.</p> 
<p>The following code will result in Lua trying to create a string variable <code>x</code>:</p>
<pre>\def\mymacro{\TeX}
\directlua{
   local x="\mymacro"
}
</pre>
<p>Within \<code>directlua</code>, the token for <code>\mymacro</code> is expanded but that results in another expandable token, <code>\TeX</code>, which is further expanded. In plain TeX, those expansions result in the following text passed to Lua:</p>
<p><code>local x = "T\kern -.1667em\lower .5ex\hbox {E}\kern -.125emX"</code></p>
<p>This code tries to define a string which contains text representing the expanded version of the <code>\TeX</code> macro. If you try to run this example Lua will attempt to construct that string but it will fail, generating an error:</p>
<p><code>invalid escape sequence near ' "T\k'.</code></p>
<p>Later in this article we’ll explore the meaning of “invalid escape sequence”.</p>
<p>Let’s now contrast the use of <code>\mymacro</code> with placing the <code>\TeX</code> token inside a token list generated by a <code>\toks</code> command:</p>
<pre>\toks100={\TeX}
\directlua{
   local x="\the\toks100"
}
</pre> 
<p>LuaTeX’s <code>\directlua</code> processing will generate this string of text for Lua:</p>
<p><code>local x = "\TeX "</code></p>
<p>The space character after <code>\TeX</code> is generated by LuaTeX’s command-token-to-string conversion process.</p>
<p><strong>But note</strong>: The <code>\TeX</code> macro has <em>not</em> been expanded into its constituent tokens. <code>\the\toks100</code> caused the tokens stored in register 100 to be inserted buts that’s all: they are <em>not</em> expanded any further and become incorporated into the main token list being build by <code>\directlua</code> (within the function <code>scan_toks()</code>). Putting tokens into a token list created by <code>\toks</code> is yet another way to prevent tokens being expanded.</p>
<p>If we run this example it too produces an error:</p>
<p><code>invalid escape sequence near ' "\T'.</code></p>
<p>We explore Lua escape sequences later in the article.</p>
<h2><span id="Other_commands.2Ftechniques_used_in_expansion"></span><span class="mw-headline" id="Other_commands/techniques_used_in_expansion">Other commands/techniques used in expansion</span></h2>
<p>In this section we look at some additional TeX commands/methods which can be useful in situations where expansion is being applied (such as within <code>\directlua</code>).</p>
<h3><span id=".5Cstring_.E2.9F.A8token.E2.9F.A9"></span><span class="mw-headline" id="\string_⟨token⟩"><code>\string ⟨token⟩</code></span></h3>
<p><code>\string</code> is an expandable command which converts the ⟨token⟩ into a series of character tokens, each with category code 12.</p>
<p>For example, <code>\string\TeX</code> would produce a series of 4 character tokens <code>\</code>, <code>T</code>, <code>e</code> and <code>X</code> where each character is assigned category code 12 (including the leading <code>\</code> character).</p>
<p>If we write</p>
<pre>\directlua{
   local x="I will use \string\newcommand" 
   print(x)
}
</pre>
<p>the <code>\string</code> command will be expanded, resulting in a sequence of character tokens with category code 12. After <code>\string</code> is expanded, the resulting character tokens (representing each character in <code>\newcommand</code>)  will be incorporated into the main token list being constructed by <code>\directlua</code>. Once <code>\directlua</code> has finished constructing its main token list, its constituent tokens are converted back to their textual representation which produces the following code for passing on to the Lua interpreter:</p>
<p><code>local x="I will use \newcommand" print(x)</code></p>
<p>When this code is passed to Lua, <code>print(x)</code> will output the string <code>x</code> to the screen (console). However, we’ve been slightly sneaky and deliberately used an example command starting with <code>\n</code>. If you are able to run this example on a local TeX installation you’ll notice that Lua prints the following text to the screen:</p>
<pre>   I will use
   ewcommand
</pre>
<p>To run this code on Overleaf you can instruct LuaTeX to write directly to the <code>.log</code> file using the LuaTeX Lua API function <code>texio.write(<em>string</em>)</code>:</p>
<pre>\directlua{
   local x="I will use \string\newcommand"
   texio.write(x)
}
</pre>
<p>If you inspect the resulting <code>.log</code> file you’ll see it also contains</p>
<pre>   I will use
   ewcommand
</pre>
<p>This unexpected output is due to Lua interpreting the <code>\n</code> at the start of <code><strong>\n</strong>ewcommand</code> as the escape sequence for the linefeed character (character code 10): it assumes that you want start a new line of text which begins with <code>ewcommand</code>. We discuss Lua escape sequences later in this article.</p>
<h3><span id=".5Cdetokenize.7B.E2.9F.A8material.E2.9F.A9.7D"></span><span class="mw-headline" id="\detokenize{⟨material⟩}"><code>\detokenize{⟨material⟩}</code></span></h3>
<p><code>\detokenize</code> is, in its effects, a multi-token version of <code>\string</code> and it too is an expandable command that converts everything in <code>⟨material⟩</code> to a sequence of character tokens with category code 12—<em>except</em> space characters (ASCII/Unicode value 32) which get category code 10. <code>\detokenize</code> also inserts a trailing space character after command names that are <em>control words</em> (e.g., <code>\foo</code>) but no space character is inserted after <em>control symbols</em> (e.g., <code>\#</code>, <code>\%</code> etc).</p>
<h3><span class="mw-headline" id="Example_5">Example</span></h3>
<p>Even if the macros <code>\foohoo</code>, <code>\foo</code>, <code>\bar</code> and <code>\foobar</code> are not defined, if you write this:</p>
<pre>\directlua{
   local x = "\string\foohoo\detokenize{\foo\bar\foobar}"
}
</pre>
<p>it would produce the following text as code for passing to the Lua interpreter</p>
<p><code>local x = "\foohoo\foo \bar \foobar "</code></p>
<p>If you do not use <code>\string</code> and <code>\detokenize</code> and write:</p>
<p><code>\directlua{local x = "\foohoo\foo\bar\foobar"}</code></p>
<p><code>\directlua</code> would process <code>\foohoo</code>, recognize it is a  command and try to expand it; but because <code>\foohoo</code> is not defined it would result in an error:</p>
<pre>   ! Undefined control sequence.
   l.1 \directlua{local x = "\foohoo
                      \foo\bar\foobar"}
         ?
</pre>
<p>Because <code>\string</code> and <code>\detokenize</code> convert their arguments into a series of character tokens, <code>\directlua</code>’s expansion process does get the opportunity to detect expandable command tokens <code>\foohoo</code>, <code>\foo</code>, <code>\bar</code>, or <code>\foobar</code>: they are turned into sequences of character tokens long before they can trigger expansion.</p>
<p>As noted previously, expansion of a command involves removing it from the input and replacing it with the result of its “expansion behaviour”. The results of expansion (usually tokens) are subsequently read by the TeX engine. Here, the “expansion behaviour” for <code>\string</code> and <code>\detokenize</code> is to absorb character and command tokens from the input and convert them to sequences of character tokens, initially  stored in a temporary token list, which <code>\directlua</code> subsequently reads. Those character tokens become incorporated into the main token list being constructed by <code>\directlua</code>.</p>
<p>The following graphic depicts how <code>\string</code> converts the <code>\foohoo</code> command to a sequence of character tokens, producing a temporary token list that is subsequently read by <code>\directlua</code> to incorporate those character tokens into the main token list being constructed.</p>
<p class="mw-empty-elt"></p><p><img src="https://images.ctfassets.net/nrgyaltdicpt/2Vt1fW4nfwrFIr4jRKXNKC/9a1239ee2469ba12115d02bf0d700dd8/foohoo_to_tokens--plain.svg" /></p>
<p class="mw-empty-elt"></p>
<p>If <code>\string</code> or <code>\detokenize</code> encounter characters in their argument e.g., <code>\string a</code> or <code>\detokenize{abc}</code> those characters (here, with category code 11) produce character tokens but with category code 12.</p>
<p>Notes:</p>
<p>If we return to the example above:</p>
<p><code>\directlua{local x = "\string\foohoo\detokenize{\foo\bar\foobar}"}</code></p>
<p>which produces the following text as code for passing to the Lua interpreter</p>
<p><code>local x = "\foohoo\foo \bar \foobar "</code></p>
<p>we can observe the following:</p>
<ul>
<li><code>\detokenize</code> has inserted a space character after each macro name but <code>\string</code> did not.</li>
<li><code>\string</code> acts on a single token.</li>
<li>In the string <code>"\foohoo\foo \bar \foobar "</code> used to define <code>x</code> we will once again encounter Lua’s escape character mechanism (discussed below): 
<ul>
<li><code>\bar</code> starts with <code>\b</code> which is the Lua escape sequence used to represent the <a href="https://en.wikipedia.org/wiki/Backspace">backspace character</a> (character code 8);</li>
 
<li>commands <code>\foohoo</code>, <code>\foo</code> and <code>\foobar</code> all starts with <code>\f</code>, the Lua escape sequence used to represent the <a href="https://en.wikipedia.org/wiki/Page_break#Form_feed">formfeed character</a> (character code 12).</li>

<p>Because the character sequences <code>\b</code> and <code>\f</code> are used within a string created using double quotes <code>"..."</code> they will produce unwanted results unless steps are taken to prevent that using Lua’s so-called <em>long-brackets</em> string method: a subject we can now discuss along with Lua escape sequences.</p>
</ul>
</li></ul>
<h2><span id="What_are_.E2.80.9CLua_escape_sequences.E2.80.9D.3F"></span><span class="mw-headline" id="What_are_“Lua_escape_sequences”?">What are “Lua escape sequences”?</span></h2>
<p>Programming languages reserve certain characters for “special use” as part of the language syntax: in effect, those characters are defined to have some form of special meaning. However, there are times when you need to temporarily “switch off” such a character’s special meaning if, for example, you want that character to be embedded as part of a longer string where it’s standard behaviour would introduce syntax errors. In essence, that character needs to be processed <em>without</em> triggering its standard interpretation—to slip through without being noticed. To do this, programmers use a technique called <em>escaping</em> in which a “special character” is represented by its so-called <em>escape sequence</em>. </p>
<p>A standard example (also supported by Lua) is using double quotes inside a string where you escape the inner double quotes using the escape sequence <code>\"</code>:</p>
<p><code>"When asked about LuaTeX they replied: \"It is an awesome TeX engine!\"  I agreed."</code></p>
<p>The Lua language provides a number of mechanisms to work with escape sequences:</p>
<ul>
<li>standard sequences including <code>\n</code> (newline), <code>\r</code> (carriage return), <code>\\</code> (backslash), <code>\"</code> (double quote), <code>\t</code> (horizontal tab), <code>\v</code> (vertical tab) and <code>\'</code> (single quote);</li>

<li><code>\xXX</code>, where <code>XX</code> is a sequence of exactly two hexadecimal digits;</li>

<li><code>\ddd</code>, where <code>ddd</code> is a sequence of up to three decimal digits;</li>

<li>at the time this article was written (August 2019) the latest version of LuaTeX, although not yet available on Overleaf, uses  version 5.3 of Lua which introduced support for UTF-8 escape sequences: <code>\u{XXX}</code>. This escape mechanism is for UTF-8 encoded Unicode characters where <code>XXX</code> is a sequence of one or more hexadecimal digits representing the character code point. Note that the enclosing brackets <code>{ }</code> are mandatory.</li>
</ul>
<h3><span class="mw-headline" id="Controlling_escape_sequences">Controlling escape sequences</span></h3>
<p>Traditionally, strings are defined using double quotes as in <code>"this is a string"</code>; within such a string you can use escape sequences:  <code>"this is a string.\nI'll now start on a new line."</code>. However,  Lua has a second and <em>very</em> convenient mechanism to define strings: its so-called <em>long brackets</em> mechanism in which you define a string by enclosing the text in <code>[[</code> and <code>]]</code>:
</p>
<p><code>[[I am a long brackets string]]</code></p>
<p>Within a string created using the long-brackets method, Lua’s character-escape mechanism is <em>switched off</em>: escape sequences are treated as regular characters. For example, in the string</p>
<p><code>[[I am a long brackets\n string]]</code></p>
<p>the <code>\n</code> escape sequence is not treated as the single carriage return character (ASCII code 13) but as two regular characters: <code>\</code> followed by <code>n</code>.</p>
<h3><span id="Why_are_long_bracket_strings_so_useful.3F"></span><span class="mw-headline" id="Why_are_long_bracket_strings_so_useful?">Why are long bracket strings so useful?</span></h3>
<p>As we’ll later explore, LuaTeX provides a suite of specialized, built-in, Lua functions that you can use with <code>\directlua</code> to control LuaTeX’s typesetting behaviour. Among those many functions is one called <code>tex.print(<em>string</em>)</code> that allows you to pass <code><em>string</em></code> material from Lua code back to LuaTeX for typesetting. A very simple example is:</p>
<p><code>\directlua{tex.print("Hello, World!")}</code></p>
<p>which will cause LuaTeX to typeset <code>Hello, World!</code></p>
<p>The <code><em>string</em></code> used in <code>tex.print(<em>string</em>)</code> can also include text representing TeX and LaTeX commands for LuaTeX to process. However, TeX/LaTeX commands start with a <code>\</code> character which is problematic with strings created using double quotes because Lua would try to parse the string, detect the initial <code>\</code> character and interpret it as the beginning of an escape sequence. When Lua tries to process the escape sequence it will usually fail because the initial <code>\</code> combined with the first character in many TeX/LaTeX command names does not form a valid escape sequence known to Lua. For example when processing a string such as <code>"I like \LaTeX"</code> Lua would see <code>\L</code> and fail with the error “invalid escape sequence”, and this is the cause of the errors noted above.</p>
<h4><span id="Long-bracket_strings_come_to_the_rescue.21"></span><span class="mw-headline" id="Long-bracket_strings_come_to_the_rescue!">Long-bracket strings come to the rescue!</span></h4>
<p>The long-brackets method of creating (defining) strings is extremely useful because even though TeX/LaTeX commands start with a <code>\</code> character, the long-brackets string method disables (switches off) Lua’s escape sequence mechanism. Here is a short example, remembering that we need to prevent macros from being expanded using, for example, <code>\protected</code> or <code>\noexpand</code>.</p>
<p>Suppose we define a <code>\newtest</code> macro like this</p>
<p><code><strong>\protected</strong>\def\newtest#1{The argument: #1}</code></p>
<p>and use it in <code>\directlua</code> with the LuaTeX Lua API function <code>tex.print()</code>:</p>
<pre>\directlua{
   tex.print("\newtest{Hello}")
}
</pre>
<p>Due to the use of <code>\protected</code>, the macro <code>\newtest</code> is not expanded which results in the following text passed to Lua:</p>
<p><code>tex.print("\newtest {Hello}")</code></p>
<p>The space character added after <code>\newtest</code> and before the opening brace (<code>{</code>) is a side-effect of <code>\directlua</code>’s conversion of command tokens back to their textual representation.</p>
<p>This code is passed to Lua which subsequently executes the LuaTeX function <code>tex.print()</code> but there’s a problem which manifests itself in ways that depend on the fonts you are using. In LaTeX on Overleaf you would see output like this:</p>
<p class="mw-empty-elt"></p><p><img src="../../../../../images.ctfassets.net/nrgyaltdicpt/4jw1pdMTTLZnR3gLfndMBB/c9140ecc0a00c853d0f4b523e920b8a3/newtest-latex.png" /></p>
<p class="mw-empty-elt"></p>
<p>along with a warning in the log file:</p>
<pre>   Missing character: There is no 
   (U+000A) in font [lmroman10-regular]:+tlig;!
</pre>
<p>In plain TeX you might see output that looks something like this:</p>
<p class="mw-empty-elt"></p><p><img src="../../../../../images.ctfassets.net/nrgyaltdicpt/1YLrE1DJGIn6HL9zN8ivF0/4bcfc59d8fca501aecfcda1b214194ff/newtest-plaintex.png" /></p>
<p class="mw-empty-elt"></p>
<p>In both cases the <code>\newtest</code> macro is not called and the output is not what we intended. The error is caused by Lua’s escape character mechanism: in the text <code>\newtest {Hello}</code> the macro name starts with <code>\n</code> which Lua recognizes as the escape sequence for a linefeed character so it replaces <code>\n</code> by ASCII character 10, or in hex 0A. In the LaTeX error message,  <code>U+000A</code> is a way to represent the Unicode value using 4 hex digits.</p>
<p>Because the <code>\n</code> is converted to the linefeed character, LuaTeX does not see a macro call but instead believes it is being asked to typeset some text that starts with ASCII character code 10:</p>
<p><code>⟨ASCII 10⟩ewtest {Hello}</code></p>
<p>Depending on the font used, LuaTeX may, or may not, be able to typeset the <code>⟨ASCII 10⟩</code> character but the remaining text is output as-is with the <code>{</code> and <code>}</code> treated as a group and not printed.</p>
<p>Plain TeX gives a different result because the default font is Computer Modern Roman which has a strange encoding that results in a capital Omega typeset when character code 10 is seen.</p>
<p>To prevent these problems we need to use long-bracket strings to prevent Lua’s escaping mechanism being applied. The correct result is produced with</p>
<p><code>\directlua{tex.print([[\newtest{Hello}]])}</code></p>
<p>which produces the result shown in the following screenshot:</p>
<p class="mw-empty-elt"></p><p><img src="../../../../../images.ctfassets.net/nrgyaltdicpt/JEBwpu4oypuEdG1KmZBaP/62d4c99896323bd9951c713cf9c1931f/newtest-working.png" /></p>
<p class="mw-empty-elt"></p>
<h3><span class="mw-headline" id="Expansion_and_non-execution_of_non-expandable_commands">Expansion and <strong>non-execution</strong> of <em>non-expandable</em> commands</span></h3>
<p>When discussing expansion we noted it is a process in which a TeX engine <em>removes</em> an expandable command (token) from the current input and <em>replaces</em> it with the result(s) produced by that expandable command. Because \directlua is performing <em>expansion-only</em> activities (to generate a token list), it <em>does not</em> take LuaTeX’s processing any further than that. Once an expandable command has been read and fully expanded the results of that expansion—which frequently includes non-expandable commands (tokens)—will be incorporated into the token list being built, ready for conversion back to text for passing on to Lua.</p> 
<p>There is an important principle at work here: during <em>expansion-only</em> activities designed to produce a token list, TeX engines, including LuaTeX, <em>do not execute</em> any non-expandable primitive, built-in, TeX commands.</p> 
<p>In the case of <code>\directlua{⟨code⟩}</code>, if the fully expanded version of your <code>⟨code⟩</code> produces, or contains non-expandable TeX/LaTeX commands they <em>will be passed on to Lua</em> (represented as text).</p>
<h4><span class="mw-headline" id="Example_6">Example</span></h4>
<p>Here is an example to demonstrate that non-expandable primitives are not executed during expansion-only processing (such as within <code>\directlua</code>). Suppose we define a macro <code>\setcountreg</code> like this:</p>
<p><code>\def\setcountreg#1#2{\count#1=#2\relax}</code></p>
<p><strong>Note</strong>:  We use <code>\relax</code> after parameter <code>#2</code> to prevent LuaTeX overshooting when scanning the input in its search for the numeric value (argument) to match parameter <code>#2</code>.</p>
<p>If, outside of <code>\directlua</code>, we later run the macro like this</p>
<pre>   \setcountreg{100}{50}
   The value in count register 100 is \the\count100.
</pre>
<p>it would output</p>
<p><code>The value in count register 100 is 50.</code></p>
<p>In this context, any TeX engine would process the macro <code>\setcountreg</code>—expand the macro, determine the arguments and continue to read <em>and action</em> (execute) commands contained in the macro’s replacement text (definition). The result here is to assign <code>50</code> as the value stored in register <code>\count100</code>.</p>
<p>However, when a TeX engine is performing <em>expansion-only</em> activities, as it is with <code>\directlua</code>, it <em>will not execute</em> the non-expandable commands contained in the macro’s definition.</p>
<p>If we write </p>
<pre>\def\setcountreg#1#2{\count#1=#2\relax}
\directlua{
   local x = [[\setcountreg{100}{50}]]
}
</pre>
<p>it produces the following text as the code for Lua:</p>
<p><code>local x = [[\count 100=50\relax ]]</code></p>
<p>The Lua code produced above shows that within <code>\directlua</code> the <code>\setcountreg</code> has been expanded, its arguments identified and substituted into the appropriate parameter (<code>#1</code> and <code>#2</code>) but it goes no further than that: the non-expandable primitive TeX command <code>\count</code> was <em>not executed</em> during <code>\directlua</code>’s expansion processing.</p>
<p>However, LuaTeX will execute the TeX code if we pass the resulting string <code>x</code> <em>back to LuaTeX</em> via <code>tex.print(x)</code> like this</p>
<pre>\count100=50 % set \count100 to a starting value of 50
\def\setcountreg#1#2{\count#1=#2\relax}
\directlua{
   local x = [[\setcountreg{100}{250}]]
   tex.print(x)
}
The value stored in count register 100 is \the\count100.
</pre>
<p>After <code>\directlua</code> has finished the ouput would be </p>
<p><code>The value stored in count register 100 is 250.</code></p>
<p>showing that count register <code>100</code> does now contain the value <code>250</code>.</p>
<p>The Lua code produced from the above example is</p>
<p><code>local x = [[\count 100=250\relax ]] tex.print(x) </code></p>
<p>This code defines <code>x</code> to be a string created using the long-brackets method which is used to avoid errors with erroneous escape sequences. If we used double quotes <code>"..."</code> to define x,   the character combination <code>\c</code> at the start of <code>\count</code> would trigger an error: <code> invalid escape sequence near ' "\c'</code>.</p>
<p>The LuaTeX Lua API call <code>tex.print(x)</code> results in LuaTeX executing the TeX code sequence <code>\count 100=250\relax</code> and <code>\count100</code> is assigned a value of <code>250</code> as seen from the typeset output:</p>
<p><code>The value stored in count register 100 is 250.</code></p>
<h4><span class="mw-headline" id="Caution:_macros_and_the_LuaTeX_Lua_API">Caution: macros and the LuaTeX Lua API</span></h4>
<p>In the above example we saw that during <code>\directlua</code>’s pre-processing (expansion) LuaTeX did not execute the code <code>\count 100=250</code>, which contains the <code>non-expandable</code> primitive command <code>\count</code>: to run (execute) that code we had to <em>pass it back to LuaTeX</em> via <code>tex.print()</code>.</p> 
<p><code>\directlua</code> is just one instance where LuaTeX is performing expansion-only processing to construct a token list. There are other commands which perform similar expansion processing and token-list generation activities, such as <code>\write</code> and <code>\edef</code>: those commands also do not execute non-expandable primitives during their expansion processing. It is general principle that TeX engines do not execute non-expandable primitives when constructing a token list during expansion-only processing activities.</p>
<h5><span class="mw-headline" id="Rewriting_our_macro_to_use_the_LuaTeX_Lua_API">Rewriting our macro to use the LuaTeX Lua API</span></h5>
<p>We can re-write the <code>\setcountreg</code> macro using a LuaTeX Lua API function called <code>tex.setcount()</code>, thus avoiding TeX commands to change the value stored in count register <code>100</code>:</p>
<pre>   \def\setcount#1#2{\directlua{tex.setcount(#1,#2)}}
   \count100=50
   count register 100 contains \the\count100\par
   \setcount{100}{250}
   count register 100 now contains \the\count100\par
</pre>
<p>This code will typeset:</p>
<pre>count register 100 contains 50
count register 100 now contains 250
</pre>
<p>Here we are using <code>tex.setcount()</code>, one of LuaTeX’s many Lua API functions, to <em>directly access</em> LuaTeX’s internal data storage area to place the value <code>250</code> in the memory location representing count register <code>100</code>. We have, in effect, <em>bypassed</em> LuaTeX’s standard TeX engine input-processing methods: reading input, creating tokens and executing TeX primitive commands. However, there is a cautionary tale: by using LuaTeX’s Lua API functions, expansion-only processing activity <em>can result in side-effects</em>: changes to values stored inside the TeX engine that would not otherwise be possible with pure TeX/LaTeX commands.</p>
<h5><span class="mw-headline" id="Example:_unexpected_side-effects">Example: <em>unexpected</em> side-effects</span></h5>
<p>Here is an example to demonstate <em>unexpected</em> side-effects which can arise with macros using <code>\directlua</code>. Suppose we write the following code:</p>
<pre>\def\dochange{\directlua{tex.setcount(999,12345)}}
\edef\careful{\dochange}    
\the\count999
</pre>
<p>Running this code typesets <code>12345</code>!</p>
<p>How can that be? We did not <em>explicity</em> call any code or macros to put that value in count register <code>999</code>. Or did we?</p>
<p>We defined <code>\dochange</code> with a <code>\directlua</code> command that uses <code>tex.setcount()</code> to store the value <code>12345</code> in count register <code>999</code>: in TeX code it is the equivalent of <code>\count999=12345</code>. We then used the standard TeX primitive <code>\edef</code> to define the macro <code>\careful</code>—it is the use of <code>\edef</code> which triggers the unexpected side-effect.</p> 
<p><code>\edef</code> fully expands its argument: here, it detects an expandable macro <code>\dochange</code> and expands it. The <code>\dochange</code> macro uses the expandable command <code>\directlua</code> which contains a Lua API call; so the expansion of <code>\dochange</code> results in expansion of <code>\directlua</code> and that causes <code>tex.setcount()</code> to be called, which changes the value in count register <code>999</code>.</p>
<p>If we redefine <code>\dochange</code> to use TeX commands:</p>
<pre>   Before: count register 999 contains \the\count999.\par
   \def\dochange{\count999=12345\relax}
   \edef\careful{\dochange}    
   After: count register 999 contains \the\count999.\par
</pre>
<p>running this code typesets</p>
<pre>Before: count register 999 contains 0.
After: count register 999 contains 0.
</pre>
<p>Clearly, there was no effect on <code>\count999</code>. When <code>\edef</code> defines <code>\careful</code> it expands <code>\dochange</code> but that expansion produces unexpandable TeX primitives only: they are <em>not executed</em> but simply <em>stored</em> in the token list comprising the definition of <code>\careful</code>.</p>
<p>Just for good measure, the same principle explains why this produces typeset output:</p>
<pre>\def\dochange{\directlua{tex.print("Hello")}}
\edef\careful{\dochange} 
</pre>
<h2><span id="Brief_introduction_to_LuaTeX.E2.80.99s_Lua_API"></span><span class="mw-headline" id="Brief_introduction_to_LuaTeX’s_Lua_API">Brief introduction to LuaTeX’s Lua API</span></h2>
<p class="mw-empty-elt"></p><p>As we’ve seen, <code>\directlua</code> not only enables you to write conventional Lua code, or a mixture of Lua and TeX/LaTeX code, but it also provides access to a suite of additional Lua functions (specific to LuaTeX) that you can use (call) to communicate with, or directly control, the inner workings of the LuaTeX typesetting software. We’ve used several Lua functions in this article, <code>tex.print()</code>, <code>texio.write()</code>, <code>tex.setcount()</code> and these, along with <em>many</em> more, are documented in <a href="http://www.pragma-ade.com/general/manuals/luatex.pdf">The LuaTeX Reference Manual</a> in which groups of related functions are referred to as <em>libraries</em>.</p>
<p class="mw-empty-elt"></p>
<p>
You can think of these Lua functions as LuaTeX’s Lua API (<strong>A</strong>pplication <strong>P</strong>rogramming <strong>I</strong>nterface) which provide the tools to construct sophisticated typesetting and document engineering solutions by controlling the typesetting behaviour of LuaTeX using Lua as the driver.</p>
<p>As noted, LuaTeX organizes its API into set of functions it called libraries: groups of functions which are related through their purpose or actions. Each set of functions is designed to provide access to particular aspect of LuaTeX’s internal processes, data structures, data storage and typesetting algorithms. Internally, LuaTeX is constructed from multiple components: software libraries/tools (mostly written in C) that not only comprise the TeX engine itself but other sub-systems including Lua, MetaPost, Kpathsea, FontForge, libpng and zlib. These libraries are integrated to build the features and functions of the LuaTeX executable software and it is through the Lua API that users are given access to LuaTeX’s functionality derived from its integration and coordination of those multiple software components.</p>
<h2><span class="mw-headline" id="Some_examples_and_pitfalls">Some examples and pitfalls</span></h2>
<p>In this section we present some further examples which make use of the topics, concepts and explanations provided in this article.</p>
<h3><span id="Challenges_using_.5C.5C_in_.5Cdirectlua"></span><span class="mw-headline" id="Challenges_using_\\_in_\directlua">Challenges using <code>\\</code> in <code>\directlua</code></span></h3>
<p class="mw-empty-elt">
</p><p>In Lua, <code>\\</code> is used as an escape sequence to represent the single character <code>\</code> but In TeX/LaTeX <code>\\</code> is a single-character <em>macro</em> (a control symbol), so it is subject to expansion within <code>\directlua</code>’s pre-processing. As noted in discussions on tex.stackexchange <a href="https://tex.stackexchange.com/questions/55470/what-does-do">What does <code>\\*</code> do?</a>, the <code>\\</code> macro is widely used in LaTeX, and LaTeX packages, to control linebreaks and other things. In that discussion <a href="https://tex.stackexchange.com/a/55481">a renowned TeX/LaTeX expert comments</a></p>
<blockquote><p>
The <code>\\</code> command is one of the most overloaded commands of LaTeX, i.e., its actual definition depends on the place where it is used.
</p></blockquote>
<p>Essentially, <code>\\</code> is frequently redefined to achieve different effects. However, let’s assume that we want to use <code>\directlua</code> to typeset the command <code>\LaTeX</code> by using the LuaTeX API call <code>tex.print()</code>. We know the Lua language uses the <code>\\</code> escape sequence to represent a single <code>\</code> hence if we write <code>\\LaTeX</code> within a <code>\directlua</code> command, will it work? Well, let’s see what happens, assuming we are running LaTeX not plain TeX or <a href="https://wiki.contextgarden.net/What_is_ConTeXt">ConTeXt</a> (a powerful non-LaTeX macro system/format):</p>

<p class="mw-empty-elt"></p>
<pre>\directlua{
   tex.print("\\LaTeX")
}
</pre>
<p>This fails with a cascade of errors, starting with something like this:</p>
<pre>   ! Undefined control sequence.
   \\  -&gt;\let \reserved@e 
                     \relax \let \reserved@f \relax \@ifstar …
</pre>
<p>If you run it under plain TeX you also get an error, albeit a different one:</p>
<pre>   ! Argument of \\ has an extra }.
</pre>
<p>When LuaTeX pre-processes <code>\directlua{tex.print("\\LaTeX")}</code>, <code>\\</code> is recognized <em>as a LaTeX macro</em> which needs to be <em>expanded</em>. It is the expansion of <code>\\</code> which triggers the errors—the exact cause of the problem(s) will depend on the way that <code>\\</code> has been defined. Ultimately, as far as LuaTeX is concerned, we are telling it to use the <code>\\</code> macro in a situation for which it was not written (defined) and thus it triggers an error.</p>
<p>However, there are multiple solutions that allow you to use <code>\\</code>.</p>
<h4><span id="Solution_1:_.5Clet.5C.5C.5Crelax"></span><span class="mw-headline" id="Solution_1:_\let\\\relax">Solution 1: <code>\let\\\relax</code></span></h4>
<p>If we write</p>
<pre>\let\\\relax
\directlua{
   tex.print("\\LaTeX")
}
</pre> 
<p>then <code>\directlua{tex.print("\\LaTeX")}</code> this will work. Why?</p>
<p>The <code>\\</code> construct can be confusing so let’s remind ourselves that TeX engines recognize two types of macro command which are known as <em>control words</em> and <em>control symbols</em>:</p>
<ul>
<li><em>control words</em>: commands constructed from one or more characters that have category code 11;
</li><li><em>control symbols</em>: single-character commands where that character’s category code is not 11: such as \$, \# or \\.
</li>
</ul>
<p>After detecting the initial <code>\</code> at the start of a command, TeX checks the category code of the first letter in the command’s name and uses the result of this test to determine if it is a control word or a control symbol. The second character in <code>\\</code> is category code 0, not 11, which means it falls into the category of control symbol but, ultimately, it is just a macro (but not all control symbols are macros as we saw in the explanation of <code>\chardef</code>).</p>
<p>When LuaTeX starts to process <code>\\</code> it looks up the meaning of that macro and discovers it is \relax so LuaTeX does just that: there is nothing to expand which results in a token for the <code>\\</code> macro being put into the token list being constructed internally (by <code>scan_toks()</code>). Once the token list has been built, the <code>tokenlist_to_cstring()</code> function converts all the tokens back to their textual representation, producing <code>tex.print("\\LaTeX")</code> which is passed to Lua. Because the <code>\\</code> sequence is Lua’s escape sequence for a single <code>\</code>, Lua processes that, resulting in the command <code>\LaTeX</code> being passed back to LuaTeX for typesetting .
</p>
<h4><span id="Solution_2:_.5Cnoexpand"></span><span class="mw-headline" id="Solution_2:_\noexpand">Solution 2: <code>\noexpand</code></span></h4>
<p>If we use \noexpand like this</p>
<pre>\directlua{
   tex.print("\noexpand\\LaTeX")
}</pre>
<p>expansion of <code>\\</code> is suppressed so a token representing the (unexpanded) macro <code>\\</code> will make it through into the token list constructed by <code>scan_toks()</code>. When the <code>tokenlist_to_cstring()</code> function converts the tokens in the token list back to their textual representation for Lua to process, Lua will see</p>
<p><code>tex.print("\\LaTeX"</code>)</p>
<p>and process <code>\\</code> as the escape sequence for a single <code>\</code>, resulting in the command <code>\LaTeX</code> being typeset.</p>
<h4><span id="Solution_3:_Using_a_string.char.28.29_.E2.80.9Ctrick.E2.80.9D"></span><span class="mw-headline" id="Solution_3:_Using_a_string.char()_“trick”">Solution 3: Using a <code>string.char()</code> “trick”</span></h4>
<p>When LuaTeX pre-processes code in a <code>\directlua</code> command it creates character tokens from regular characters (usually category codes 10, 11 and 12) and only takes further action, such as expansion, when it detects characters with category codes 13 (active characters) or detects expandable primitive commands and macros.</p>
<p>We can use the standard Lua function <code>string.char()</code> to write</p>
<pre>\directlua{
   local sl = string.char(92)
   local txt = sl.."LaTeX"
   tex.print(txt)
}
</pre>
<p>This works because the expansion process in <code>\directlua</code> simply does not see any characters that trigger expansion: our code is comprised of regular characters with category codes 10, 11 and 12 so it passes straight through the tokenization process. When those tokens are converted back to text the following code will be passed to Lua:</p>
<p><code>local sl = string.char(92) local txt = sl.."TeX" tex.print(txt)</code></p>
<p>When Lua processes this code, the string variable <code>txt</code> becomes the concatenation of <code>\</code> and <code>LaTeX</code>; i.e., <code>txt="\LaTeX"</code> which, via the LuaTeX API function call <code>tex.print(txt)</code>, is typeset.</p>
<h4><span id="Solution_4:_Using_.5Cstring.5C.5C"></span><span class="mw-headline" id="Solution_4:_Using_\string\\">Solution 4: Using <code>\string\\</code></span></h4>
<p>The TeX primitive <code>\string⟨token⟩</code> is an expandable command whose expansion behaviour is to convert <code>⟨token⟩</code> into its human-readable form using characters with category code 12. If <code>⟨token⟩</code> represents a macro or primitive <code>\string</code> will output a sequence of category code 12 characters including the leading <code>\</code> character (or whatever <code>\escapechar</code> is defined to be at the time of doing the conversion). If we write</p>
<pre>\directlua{
   tex.print("\string\\LaTeX")
}
</pre>
<p>The result of expanding <code>\string\\</code> is to convert <code>\\</code> into two character tokens: two <code>\</code> characters each with category code 12. This prevents the two-character sequence <code>\\</code> being interpreted (expanded) as a macro and both <code>\</code> character tokens are incorporated into the token list being built by <code>\directlua</code>. When that token list is converted back to text, the resulting Lua code is</p>
<p><code>tex.print("\\LaTeX")</code></p>
<p>in which Lua will interpret <code>\\</code> as the escape sequence for <code>\</code>, resulting in <code>\LaTeX</code> being typeset.</p>
<h3><span id="Using_the_tilde_character_.28.7E.29"></span><span class="mw-headline" id="Using_the_tilde_character_(~)">Using the tilde character (<code>~</code>)</span></h3>
<p>The Lua language uses the <code>~</code> character (called tilde) as part of its syntax, including its syntax for performing a “not equal” test; for example, to test if a variable <code>x</code> is not equal to <code>4</code> we could write:</p>
<pre>   local x=3
   if x ~= 4 then
   print("x is not equal to 4")
   end
</pre>
<p>If we try to run this simple Lua code via <code>\directlua</code>:</p>
<pre>\directlua{
   local x=3
   if x ~= 4 then
   print("x is not equal to 4")
   end
}
</pre>
<p>we get an error:</p>
<p><code>[\directlua]:1: 'then' expected near '\'.</code></p>
<p>That’s odd because our code is correct: we have used <code>'then'</code> and there is no <code>\</code> character in our code, so what went wrong? To understand this, we must remember that, to TeX/LaTeX, <code>~</code> is usually defined to be a “special character” with category code 13: so-called active characters which are mini-macros and thus subject to expansion. When <code>\directlua</code> detects the <code>~</code> character it is expanded by <em>removing it</em> from the input and <em>replacing it</em> with the result of its expansion. Using plain TeX, the resulting text (code) that LuaTeX produces and passes to the Lua interpreter does not actually contain the <code>~</code> character, and is:</p>
<p> <code>local x=3 if x \penalty \@M \ = 4 then print("x is not equal to 4") end</code></p>
<p>The <code>~</code> character has been <em>removed</em> and <em>expanded</em> into its constituent commands—the Lua code above results from plain TeX’s definition of the active character <code>~</code>. Now we can see why Lua responds with the error <code>'then' expected near '\'</code>—it starts to parse this code but encounters the word <code>\penalty</code> which means nothing to Lua and generates a syntax error.</p>
<p>To fix this, the <code>~</code> character needs to have a safe category code at the time <code>\directlua</code> is processing your code; for example, we can temporarily change the category code of <code>~</code> to 11 (letter) by enclosing the code in a group:</p>
<pre>\begingroup
\catcode`\~=11
\directlua{
   local x=3
   if x ~= 4 then
   print("x is not equal to 4")
   end
}
\endgroup
</pre>
<p>This code works as expected and <code>x is not equal to 4</code> is printed to the console. There are other options: we can use the expandable commands <code>\noexpand</code> or <code>\string</code>.</p>
<h4><span id="Using_.5Cstring.E2.9F.A8token.E2.9F.A9"></span><span class="mw-headline" id="Using_\string⟨token⟩">Using <code>\string⟨token⟩</code></span></h4>
<p>We can apply <code>\string</code> to the single-character <code>⟨token⟩</code> <code>~</code> which has category code 13 (active character); <code>\string</code> converts the <code>~</code> character to generate a character token which has category code 12. If we do</p>
<pre>\directlua{
   local x=3
   if x \string~= 4 then
   print("x is not equal to 4")
   end
}
</pre>
<p>it produces the Lua code we require:</p>
<p><code>local x=3 if x ~= 4 then tex.print("x is not equal to 4") end</code></p>
<h4><span id="Using_.5Cnoexpand.E2.9F.A8token.E2.9F.A9"></span><span class="mw-headline" id="Using_\noexpand⟨token⟩">Using <code>\noexpand⟨token⟩</code></span></h4>
<p>We can use <code>\noexpand~</code> to suppress expansion of the active character <code>~</code></p>
<pre>\directlua{
   local x=3
   if x \noexpand~= 4 then
   print("x is not equal to 4")
   end
}
</pre>
<p>The unexpanded <code>~</code> token passes through to the token list being built in <code>\directlua</code> and will be converted back to text which produces working Lua code.</p>
<h3><span id="Using_the_.23_character"></span><span class="mw-headline" id="Using_the_#_character">Using the <code>#</code> character</span></h3>
<p>Within the Lua language the <code>#</code> character can be used to find the length of a table. However, if we try the following code</p>
<pre>\directlua{
   local tbl = {}
   tbl[1] = "Hello"
   tbl[2] = "World"
   tex.print("Table length is "..#tbl)
}
</pre>
<p>we might expect LuaTeX to typeset</p>
<p><code>Table length is 2</code></p>
<p>but it generates an error:</p>
<p><code>\directlua]:1: attempt to get length of a number value</code></p>
<p>This error is triggered because the <code>#</code> character usually has category code 6 (macro parameter)—the <code>#</code> character has two uses in TeX/LaTeX: to indicate macro parameters (<code>#1</code>, <code>#2</code>… <code>#9</code>) and the replacement text in alignment templates (for <code>\halign</code> and <code>\valign</code>).</p>
<p>When <code>\directlua</code> is generating tokens to build its token list it sees the <code>#</code> character with category code 6 and creates a suitable character token to represent it. When the time comes to convert the final token list back to textual form, the character token for <code></code># (with category code 6) receives a special treatment: it is output as <em>two consecutive characters</em>: <code>##</code>, resulting in the following code being passed to Lua:</p>
<p><code>local tbl = {} tbl[1] = "Hello" tbl[2] = "World" print(##tbl)</code></p>
<p>On conversion to Lua code, the original <code>#</code> has been doubled and that generates an error:</p>
<p><code>\directlua]:1: attempt to get length of a number value</code></p>
<p>This problem arises due to TeX’s syntax which uses a double hash symbol <code>##</code> to represent or generate a single <code>#</code> token; this syntax is used in macros which define other macros that take parameters, or in macros used to create templates for the <code>\halign</code> or <code>\valign</code> table-construction commands. This is rather confusing so let’s look at an example.</p>
<h4><span class="mw-headline" id="Example_7">Example</span></h4>
<p>Suppose we define a macro <code>\mymacro</code> which takes a single parameter, <code>#1</code>, but it also defines a second macro <code>\foo</code> which itself takes a single parameter. To distinguish between the parameter <code>#1</code> used with <code>\mymacro</code> and the need to define <code>\foo</code> to use its own parameter <code>#1</code> TeX syntax requires that you use <code>##1</code> inside <code>\mymacro</code> to represent the parameter to be used with <code>\foo</code>:</p>
<p><code>\def\mymacro#1{\def\foo##1{#1 Hello##1}}</code></p>
<p>If you were to write <code>\mymacro{Hey!}</code> it would define the macro <code>\foo</code> to be</p>
<p><code>\def\foo#1{Hey! Hello#1}</code></p>
<p>Note that the <code>\mymacro</code>’s parameter <code>#1</code> (<code>Hey!</code>) has been incorporated into the definition of <code>\foo</code> and the sequence <code>##1</code> has been converted to <code>#1</code> in the definition of <code>\foo</code>. So we can use <code>\foo</code> like this:</p>
<p><code>\foo{, World!}</code></p>
<p>to typeset <code>Hey! Hello, World!</code></p>
<p>We can resolve <code>\directlua</code>’s treatment of the <code>#</code> character by temporarily changing its category code before LuaTeX processes the code. For example:</p>
<pre>\begingroup
   \catcode`\#=11
   \directlua{
   local tbl = {}
   tbl[1] = "Hello"
   tbl[2] = "World"
   tex.print("Table length is "..#tbl)
}
\endgroup
</pre>
<p>This generates the Lua code </p>
<pre>local tbl = {} tbl[1] = "Hello" tbl[2] = "World" tex.print("Table length is "..#tbl)</pre>
<p>which typesets the result we expected:</p>
<p><code>Table length is 2</code></p>
<h3><span id="Using_the_.25_character"></span><span class="mw-headline" id="Using_the_%_character">Using the <code>%</code> character</span></h3>
<p>Within TeX/LaTeX, the <code>%</code> character is typically used to include single-line comments in your code: to signal to the TeX engine that it should ignore everything from that point until the end of the line on which the <code>%</code> is written. However, within the Lua language, the <code>%</code> character is used within some very useful string-processing functions, such as <code>string.format(...)</code>,  <code>string.gmatch(...)</code>, and <code>string.gsub(...)</code> in which the <code>%</code> character plays an important role as part of those function’s syntax.</p>
<p>When used with TeX/LaTeX, <code>%</code> acts as the comment character because it is assigned category code 14. To make it behave as regular character, and switch off its usual TeX/LaTeX behaviour, we need to change its category code to something safe, such as 12. The <code>\directlua</code> example below uses a number of techniques discussed earlier in the article, together with one that we have not yet mentioned: <code>\catcode`\^^M=12</code>, which allows us to use Lua comments in our code; this is discussed below. </p>
<h4><span class="mw-headline" id="Example_8">Example</span></h4>
<p class="mw-empty-elt">
</p><p>The following examples are borrowed from <a href="http://lua-users.org/wiki/StringLibraryTutorial">lua-users.org</a>, suitably modified for use within <code>\directlua</code>. </p>


<p class="mw-empty-elt"></p>
<pre>\documentclass{article}
\begin{document}
\begingroup
\ttfamily
\let\\\relax
\catcode`\^^M=12 %&lt;---we further explore this below!
\catcode`\%=12
\directlua{
   local str -- declare a local variable to hold the result

   tex.print("Using string.format():".."\\par")

   str=string.format("%s %q", "Hello", "Lua user!") -- string and quoted string
   tex.print(str.."\\par")
   str = string.format("%c%c%c", 76, 117, 97) -- char
   tex.print(str.."\\par")
   str=string.format("%e, %E", math.pi, math.pi) -- exponent
   tex.print(str.."\\par")
   str=string.format("%f", math.pi) -- float
   tex.print(str.."\\par")
   str=string.format("%g, %g", math.pi, 10^9) -- float or exponent
   tex.print(str.."\\par")
   str = string.format("%o, %x, %X", 99, 125, 125)  -- octal, hexadecimal, hexadecimal
   tex.print(str.."\\par")

   tex.print("\\vskip3mm".."Using string.gmatch():".."\\par")

   for word in string.gmatch("Hello TeX user", "%a+") do 
      tex.print(word.."\\par")
   end

   tex.print("\\vskip3mm".."Using string.gsub():".."\\par")
   str=string.gsub("banana", "(an)", "%1-") -- capture any occurrences of "an" and replace
   tex.print(str.."\\par")
}
\endgroup
\end{document}
</pre>
<p class="mw-empty-elt">
</p><p>The following screenshot shows the typeset result of the code above:</p>
<p><img src="../../../../../images.ctfassets.net/nrgyaltdicpt/1mgzgT2pgEFaHpTYYD1KZe/3acf108e52d9ed6e839446161507afef/strings.png" alt="Using Lua string frunctions in \directlua" />

</p><p class="mw-empty-elt"></p>
<h2><span id="Why_is_Lua_code_shown_on_a_single_line.3F"></span><span class="mw-headline" id="Why_is_Lua_code_shown_on_a_single_line?">Why is Lua code shown on a single line?</span></h2>
<p>As you may have noticed, all the (generated) Lua code fragments shown in this article’s examples are presented as a single line of text: line breaks originally present in the <code>\directlua</code> code snippets are not followed. Why is that? It is because line breaks in the Lua code have been <em>stripped out</em> during LuaTeX’s pre-processing within <code>\directlua</code>, causing the Lua code to become one long line of text. That behaviour can be traced to the way TeX engines handle end-of-line characters—denoted by <code>\r</code> (carriage return) and <code>\n</code> (line feed) within programming literature. Just why we might need to worry about these fine details will become clear when we discuss using Lua’s mechanisms for commenting-out sections of code.</p>
<p class="mw-empty-elt">
</p><p>When software writes (saves) a text file, each individual line of text is terminated by so-called “newline” characters—the actual newline character(s) depend on the application and operating system being used to write-out that file. Wikipedia has an  <a href="https://en.wikipedia.org/wiki/Newline">interesting article</a> which explores the history/evolution of the newline characters in use today.</p>

<p class="mw-empty-elt"></p>
<p>Given any text file, its individual lines of text could be terminated by various combinations of characters, referred to as carriage return (ASCII/Unicode character 13) and/or line feed (ASCII/Unicode character 10), which are denoted by <code>\r</code> and <code>\n</code> respectively. Because TeX engines are designed to be platform independent they need a method to circumvent the inherently platform-dependent nature of line endings used in text files. Naturally, TeX engines have a built-in (but configurable) method for dealing with line-termination characters.</p>
<h3><span class="mw-headline" id="How_TeX_engines_deal_with_line_endings">How TeX engines deal with line endings</span></h3>
<p class="mw-empty-elt">
</p><p>When LuaTeX is processing <code>\directlua{⟨code⟩}</code> it reads the text contained in your <code>⟨code⟩</code> and applies standard TeX engine methods for processing any line endings contained in your <code>⟨code⟩</code>. By default, those standard TeX methods cause all line-termination characters (carriage returns and line feeds) to be removed and replaced by space characters. We say “by default” because a TeX engine’s handling of line-termination characters can be modified through a user-configurable parameter called <code>\endlinechar</code>. Here, we’ll provide a short two-step overview but further details can be found in the Overleaf article <a href="../An_introduction_to_/endlinechar__How_TeX_reads_lines_from_text_files.html">An introduction to \endlinechar: How TeX reads lines from text files</a>.</p>   

<p class="mw-empty-elt"></p>
<h4><span class="mw-headline" id="Step_1:_TeX_inserts_its_own_end-of-line_character">Step 1: TeX inserts its own end-of-line character</span></h4>
<p>After reading a line of text from your input file, TeX engines immediately remove any <code>\r</code> or <code>\n</code> characters from the end of that line. Next, TeX engines <em>insert</em> (add-back) their own line-termination character to the end of that line. That character is determined by the value of a user-configurable TeX parameter called <code>\endlinechar</code> and it is through this mechanism TeX engines can process end-of-line characters in a platform-independent manner: they choose, and set, the end-of-line character irrespective of what was originally contained in the input text file.</p>
<p>Typically, TeX engines use the setting</p>
<p><code>\endlinechar=13</code></p>
<p>which is the carriage-return character (<code>\r</code>). However, users can always assign another character code as the value of <code>\endlinechar</code>—which we’ll see later in this article.</p>
<p>Consequently, any line-termination character(s) contained in your <code>⟨code⟩</code> to be processed by <code>\directlua{⟨code⟩}</code> are stripped out and replaced by a single character determined by the TeX engine itself. Note that TeX engines perform this end-of-line processing immediately after reading a new line of text from a file and <em>before</em> processing any characters in that line (to generate tokens). However, this is not the end of the story: what the TeX engine <em>does</em> with those end-of-line characters (it has insered) explains why the Lua code becomes one single line.</p>
<h4><span class="mw-headline" id="Step_2:_TeX_converts_its_end-of-line_character_to_a_space">Step 2: TeX converts its end-of-line character to a space</span></h4>
<p>In addition to inserting their own line-termination character, defined by the value of <code>\endlinechar</code>, TeX engines also use category code 5 for characters that should be <em>treated as</em> an end-of-line character. This results in TeX engines usually working with:</p> 
<ol>
<li>an end-of-line character defined by <code>\endlinechar</code>;</li>
<li>that same character <em>usually</em> being assigned category code 5.</li>
</ol>
<p>It is what TeX does to that end-of-line character which explains our quandary regarding single lines of Lua code. When a TeX engine processes a line of input it will, eventually, detect the last character in that line: the character defined by <code>\endlinechar</code>. Usually, that character has category code 5 which causes TeX to <em>replace it</em> with a space character: i.e., at the end-of-lines TeX, in effect, strips out its line-termination character and replaces it with a space. As a side note, TeX engines also use characters with category code 5 to detect blank lines and start a new paragraph, but we won’t address that here.</p>
<p>Of course, being TeX, you can perform all sorts of special macro programming tricks by re-setting the <code>\endlinechar</code> to some other character, and/or giving the character assigned to <code>\endlinechar</code> a category code value of your choice.</p>
<p>If you want to prevent Lua code becoming one single line of text you can either (temporarily) change the value assigned to <code>\endlinechar</code> or change the category code of the standard end-of-line terminator <code>\r</code>.</p>
<h3><span id="TeX.E2.80.99s_bizarre_.5E.5E_notation"></span><span class="mw-headline" id="TeX’s_bizarre_^^_notation">TeX’s bizarre <code>^^</code> notation</span></h3>
<p>In the following sections we will encounter TeX’s unusual <code>^^</code> notation, which is known as the “extended character mechanism”. It was designed by Knuth as a way to facilitate typing “control characters” such as end-of-line terminators, tabs and so forth. For example:</p>
<ul>
<li><code>^^J</code> represents character code 10 (<code>\n</code>, line feed);</li>
<li><code>^^M</code> represents character code 13 (<code>\r</code>, carriage return).</li>
</ul>
<p>Character sequences such as <code>^^M</code> are converted to their corresponding character codes early on in TeX’s input-scanning process, when TeX is reading input characters to generate the corresponding character tokens.</p>
<h3><span id="Changing_the_character_assigned_to_.5Cendlinechar"></span><span class="mw-headline" id="Changing_the_character_assigned_to_\endlinechar">Changing the character assigned to <code>\endlinechar</code></span></h3>
<p>Remembering that we still need to prevent expansion of the <code>~</code> character, we can write</p>
<pre>\begingroup
\endlinechar=10 % Change the end-of-line character to \n
\directlua{
   local x=3
   if x \noexpand~= 4 then
   print("x is not equal to 4")
   end
}% don’t want the \n appearing here
\endgroup% or a \n here
</pre>
<p>The above setting for <code>\endlinechar</code> causes LuaTeX to append character code 10 (<code>\n</code>, line feed) to the end of each line it reads in. We do this because <code>\n</code> (line feed) usually has category code 12, which you can test by writing <code>\the\catcode`\^^J</code>. Because <code>\n</code> does not have category code 5, LuaTeX won’t convert it to a space character so it remains at the end of every line read-in by LuaTeX. This results in a character with code 10 remaining at the end of every line, thus making it through into the token list being built by <code>\directlua</code> and subsequently reappearing in the Lua code once the token list is converted to text. With the above change, the Lua code is sent to the Lua interpreter as the following sequence of characters:</p>
<p><strong>\n</strong>local x=3<strong>\n</strong>if x ~= 4 then<strong>\n</strong>print("x is not equal to 4")<strong>\n</strong>end<strong>\n</strong></p>
<p>where the <strong>\n</strong> notation is meant to represent character code 10 <em>not</em> some unknown macro <code>\n</code>. Now, the Lua interpreter will see line breaks in the code, exactly as it was originally written in the <code>\directlua</code> command:</p>
<pre>   local x=3
   if x ~= 4 then
   print("x is not equal to 4")
   end
</pre>
<p>Incidentally, note that the very first character in the Lua code string is <code>\n</code> (before the <code>local</code> keyword). That <code>\n</code> arises from the line</p>
<p><code>\directlua{</code></p>
<p>because there is a line break immediately after the opening <code>{</code> and this too is preserved. To prevent it you can write</p>
<p><code>\directlua{%</code></p>
<h3><span id="Changing_the_category_code_of_.5Cr"></span><span class="mw-headline" id="Changing_the_category_code_of_\r">Changing the category code of \r</span></h3>
<p>To maintain line breaks in our Lua code we can also change the category code of <code>\r</code> to something other than 5, so that <code>\r</code> is no longer recognized (treated as) an end-of-line character. With this technique LuaTeX still uses <code>\endlinechar=13</code> and will continue to add a <code>\r</code> to the end of each line; however, because <code>\r</code> no longer has category code 5, LuaTeX will not recognize the <code>\r</code> character as an end-of-line: it will not convert it to a space and passes it through unscathed to appear in the Lua code.</p>
<p>Remembering that we still need to prevent expansion of the <code>~</code> character, we can write</p>
<pre>\begingroup
\catcode`\^^M=12 % change category code of \r to 12 
\directlua{
   local x=3
   if x \noexpand~= 4 then
   print("x is not equal to 4")
   end
}
\endgroup
</pre>
<p>In this instance the Lua code is sent to the Lua interpreter as:</p>
<p><strong>\r</strong>local x=3<strong>\r</strong>if x ~= 4 then<strong>\r</strong>print("x is not equal to 4")<strong>\r</strong>end<strong>\r</strong></p>
<p>where the <code>\r</code> notation is meant to represent character code 13 not some unknown macro <code>\r</code>. As with the <code>\endlinechar</code> example, the Lua interpreter will see now line breaks in the code, exactly as it was originally written in the <code>\directlua</code> command:</p>
<pre>   local x=3
   if x ~= 4 then
   print("x is not equal to 4")
   end
</pre>
<p>Incidentally, note again that the very first character in the Lua code string is <code>\r</code> (before the local keyword): this too arises from the line</p>
<p><code>\directlua{</code></p>
<h4><span id="Why_did_.5Cr_use_category_code_12_but_not_category_code_11.3F"></span><span class="mw-headline" id="Why_did_\r_use_category_code_12_but_not_category_code_11?">Why did <code>\r</code> use category code 12 but not category code 11?</span></h4>
<p>The answer is due to the risk of accidentally introducing errors triggered by <code>\r</code> (of category code 11) being added to the end of TeX/LaTeX commands read from our input file. Take this example:</p>
<pre>\begingroup
\catcode`\^^M=11 % change category code of \r to 11 
\directlua{
   local x=3
   if x \noexpand~= 4 then
   print("x is not equal to 4")
   end
}
\endgroup
</pre>
<p>which generates an error:</p>
<pre>   ! Undefined control sequence.
   l.9 \endgroup
</pre>
<p>How can that be true because <code>\endgroup</code> is a standard TeX primitive command? The cause of the error is quite subtle: When LuaTeX read the last line of text—the one containing <code>\endgroup</code>—it also added the <code>\endlinechar</code> character <code>\r</code> to the end of that line. Now, inside its memory, LuaTeX sees the character sequence</p>
<p><code>\endgroup\r</code></p>
<p>
where we use <code>\r</code> to indicate the character with code 13—not the name of some unknown TeX macro <code>\r</code>.</p>
<p>At the time LuaTeX read this line from our text file the original <code>\begingroup</code> is still operational: we are inside a group that has not yet been closed by executing the matching <code>\endgroup</code> command—which would cause <code>\r</code> to revert back to its previous category code value of 5.</p>
<p>When LuaTeX begins to process (create tokens) from the line of text <code>\endgroup\r</code> it recognizes the first character <code>\</code> as the escape character which triggers LuaTeX to start looking for the name of a command. To identify a command name LuaTeX looks for a sequence of characters with category code 11 but because <code>\r</code> also has category code 11 LuaTeX thinks the <code>\r</code> character (still with category code 11) forms <em>part of a command</em> named <code>\endgroup\r</code> which, of course, does not exist so LuaTeX reports an <code>Undefined control sequence</code> error. That’s why we used category code 12 and not 11.</p>
<p>Because LuaTeX’s error message was written to the console we could not easily see/notice the <code>\r</code> character so it was not obvious what had caused the error.</p>
<h3><span id="Why_are_we_worrying_about_end-of-lines.3F"></span><span class="mw-headline" id="Why_are_we_worrying_about_end-of-lines?">Why are we worrying about end-of-lines?</span></h3>
<p>The reason is to enable use of Lua’s commenting method in your code! You can use LuaTeX’s standard mechanism of adding <code>%</code> characters to comment-out single lines within your code; however, the Lua language has its own, very useful, <em>multi-line</em> commenting mechanisms that you might want to take advantage of.</p>
<p>Let’s start by seeing what happens if we try to use single-line Lua language comments without addressing linebreak issues. Whereas TeX uses the <code>%</code> character to comment out single lines of code, Lua uses a double hyphen: <code>--</code>.</p>
<p>What happens if we try to run this:</p>
<pre>\directlua{
   local x=3
   if x \noexpand~= 4 then
   -- I'm going to output the result of this complex test
   print("x is not equal to 4")
   end
}
</pre>
<p>We get an error:</p>
<p><code>[\directlua]:1: 'end' expected near &lt;eof&gt;</code></p>
<p>This error is caused by the absence of linebreaks in the Lua code passed to the interpreter, which sees only one single continuous string in which the comment starts part-way into that string:</p>
<pre> 
local x=3 if x ~= 4 then -- I'm going to output the result of this complex test print("x is not equal to 4") end
</pre>
<p>Everything after  <code><strong>local x=3 if x ~= 4 then</strong></code> is treated as being commented out which causes the interpreter to see an incomplete chunk of Lua code, resulting in the error</p>
<p><code>'end' expected near &lt;eof&gt;</code>.</p>
<p>where <code>&lt;eof&gt;</code> means end of file.</p>
<p>As you have probably guessed, we must remedy this by ensuring line breaks are transmitted through to the resulting Lua code, which we can accomplish by, for example, by changing the category code of <code>\r</code> to 12:</p>
<pre>\begingroup
\catcode`\^^M=12 % change category code of \r to 12
\directlua{
   local x=3
   if x \noexpand~= 4 then
   -- I’m going to output the result of this complex test
   print("x is not equal to 4")
   end
}
\endgroup
</pre>
<p>Now, the Lua interpreter sees a string but it contains <code>\r</code> line breaks as written in the <code>\directlua</code> fragment:</p>
<p><strong>\r</strong>local x=3<strong>\r</strong>if x ~= 4 then<strong>\r</strong>-- I'm going to output the result of this complex test<strong>\r</strong>tex.print("x is not equal to 4")<strong>\r</strong>end<strong>\r</strong></p>
<p>This, in effect, is equivalent to writing</p>
<pre>   local x=3
   if x \noexpand~= 4 then
   -- I’m going to output the result of this complex test
   print("x is not equal to 4")
   end
</pre>
<p>which means Lua is able to process this code correctly and ignore the line we commented out.</p>
<h5><span class="mw-headline" id="Block_comments">Block comments</span></h5>
<p class="mw-empty-elt">
</p><p>The Lua language also supports a syntax it calls <a href="https://www.lua.org/pil/1.3.html">“block comment”</a> (or <em>long comment</em>): these start with <code>--[[</code> and are in effect until the corresponding <code>]]</code>. We can use this convenient syntax to write multi-line comments, or comment out sections of code we want to temporarily remove:</p>

<p class="mw-empty-elt"></p>
<pre>\begingroup
\catcode`\^^M=12 % change category code of \r to 12
\directlua{
   local x=3
   if x \noexpand~= 4 then
   --[[ I’m going to output the result of this complex test
   simply because it really is
   such an amazing conclusion]]
   print("x is not equal to 4")
   end
}
\endgroup
</pre>
<h2><span class="mw-headline" id="In_conclusion">In conclusion</span></h2>
<p class="mw-empty-elt">
</p><p>Firstly, congratulations if you have managed to read through this substantial article! We have tried to produce a reasonably comprehensive guide to TeX-related concepts and topics which provide the background needed to get the most from LuaTeX via the <code>\directlua</code> command. It is our hope to have produced an article which is instructive and contributes something of use and value to the Overleaf user community, and beyond. As always, we are delighted to receive feedback so do please feel free to <a href="https://www.overleaf.com/contact">contact us</a> with comments on this article or suggestions for further topics you would like us to write about.</p>

<p class="mw-empty-elt"></p>
<p>Happy \(\text{Lua}\mathrm{\TeX}\text{-ing!}\) from Graham Douglas and the Overleaf team.</p>
<h3><span class="mw-headline" id="And_finally..._just_use_the_luacode_package">And finally... just use the <code>luacode</code> package</span></h3>
<p class="mw-empty-elt">
</p><p>Although TeX and Lua operate in fundamentally different ways, those languages share a number of characters that have “special meanings” within the context of each language—such as \, %, ~, #, ^, &amp;—of course, Lua and TeX assign those special meanings for <em>very</em> different purposes. Our exploration of problematic characters shows why difficulties can arise and how you can resolve them; however, it could be rather tedious to manually fix many small Lua code fragments so most users prefer to use LaTeX packages which remove those challenges. One such package is <a href="https://ctan.org/pkg/luacode?lang=en"><code>luacode</code></a> which provides a suite of features designed to simplify working with <code>\directlua</code>, but at least you may now have a better understanding of the issues <code>luacode</code> solves for you.
</p>


<p class="mw-empty-elt"></p>




</div></div></div></div></div><div class="col-xs-12 col-sm-3 col-sm-pull-9 contents card" ng-non-bindable><div class="mw-parser-output"><ul><li><a href="../../../../learn.html" title="Main Page">Documentation Home</a></li>
<li><a href="../../Learn_LaTeX_in_30_minutes.html" title="Learn LaTeX in 30 minutes">Learn LaTeX in 30 minutes</a></li></ul>
<h2><span class="mw-headline">Overleaf guides</span></h2>
<ul><li><a href="https://www.overleaf.com/learn/how-to/Creating_a_document_in_Overleaf" title="Kb/Creating a document in Overleaf">Creating a document in Overleaf</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Uploading_a_project" title="Kb/Uploading a project">Uploading a project</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Copying_a_project" title="Kb/Copying a project">Copying a project</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Creating_a_project_from_a_template" title="Kb/Creating a project from a template">Creating a project from a template</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Using_the_Overleaf_project_menu" title="Kb/Using the Overleaf project menu">Using the Overleaf project menu</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Including_images_on_Overleaf" title="Kb/Including images on Overleaf">Including images in Overleaf</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Exporting_your_work_from_Overleaf" title="Kb/Exporting your work from Overleaf">Exporting your work from Overleaf</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Working_Offline_in_Overleaf" title="Kb/Working Offline in Overleaf">Working offline in Overleaf</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Track_Changes_in_Overleaf" title="Kb/Track Changes in Overleaf">Using Track Changes in Overleaf</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Using_bibliographies_on_Overleaf" title="Kb/Using bibliographies on Overleaf">Using bibliographies in Overleaf</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Sharing_a_project" title="Kb/Sharing a project">Sharing your work with others</a></li>
<li><a href="../../Using_the_History_feature.html" title="Using the History feature">Using the History feature</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Why_do_I_keep_getting_the_compile_timeout_error_message%3F" class="mw-redirect" title="Kb/Why do I keep getting the compile timeout error message?">Debugging Compilation timeout errors</a></li>
<li><a href="https://www.overleaf.com/learn/how-to" class="mw-redirect" title="Kb/Knowledge Base">How-to guides</a></li>
<li><a href="https://www.overleaf.com/learn/how-to/Overleaf_premium_features" title="Kb/Overleaf premium features">Guide to Overleaf’s premium features</a></li></ul>
<h2><span class="mw-headline">LaTeX Basics</span></h2>
<ul><li><a href="../../Learn_LaTeX_in_30_minutes.html" class="mw-redirect" title="Creating a document in LaTeX">Creating your first LaTeX document</a></li>
<li><a href="../../Choosing_a_LaTeX_Compiler.html" title="Choosing a LaTeX Compiler">Choosing a LaTeX Compiler</a></li>
<li><a href="../../Paragraphs_and_new_lines.html" title="Paragraphs and new lines">Paragraphs and new lines</a></li>
<li><a href="../../Bold%2c_italics_and_underlining.html" title="Bold, italics and underlining">Bold, italics and underlining</a></li>
<li><a href="../../Lists.html" title="Lists">Lists</a></li>
<li><a href="../../Errors.html" title="Errors">Errors</a></li></ul>
<h2><span class="mw-headline">Mathematics</span></h2>
<ul><li><a href="../../Mathematical_expressions.html" title="Mathematical expressions">Mathematical expressions</a></li>
<li><a href="../../Subscripts_and_superscripts.html" title="Subscripts and superscripts">Subscripts and superscripts</a></li>
<li><a href="../../Brackets_and_Parentheses.html" title="Brackets and Parentheses">Brackets and Parentheses</a></li>
<li><a href="../../Matrices.html" title="Matrices">Matrices</a></li>
<li><a href="../../Fractions_and_Binomials.html" title="Fractions and Binomials">Fractions and Binomials</a></li>
<li><a href="../../Aligning_equations_with_amsmath.html" title="Aligning equations with amsmath">Aligning equations</a></li>
<li><a href="../../Operators.html" title="Operators">Operators</a></li>
<li><a href="../../Spacing_in_math_mode.html" title="Spacing in math mode">Spacing in math mode</a></li>
<li><a href="../../Integrals%2c_sums_and_limits.html" title="Integrals, sums and limits">Integrals, sums and limits</a></li>
<li><a href="../../Display_style_in_math_mode.html" title="Display style in math mode">Display style in math mode</a></li>
<li><a href="../../List_of_Greek_letters_and_math_symbols.html" title="List of Greek letters and math symbols">List of Greek letters and math symbols</a></li>
<li><a href="../../Mathematical_fonts.html" title="Mathematical fonts">Mathematical fonts</a></li>
<li><a rel="nofollow" class="external text" href="https://www.overleaf.com/learn/how-to/Using_the_Symbol_Palette_in_Overleaf">Using the Symbol Palette in Overleaf</a></li></ul>
<h2><span class="mw-headline">Figures and tables</span></h2>
<ul><li><a href="../../Inserting_Images.html" title="Inserting Images">Inserting Images</a></li>
<li><a href="../../Tables.html" title="Tables">Tables</a></li>
<li><a href="../../Positioning_images_and_tables.html" title="Positioning images and tables">Positioning Images and Tables</a></li>
<li><a href="../../Lists_of_tables_and_figures.html" title="Lists of tables and figures">Lists of Tables and Figures</a></li>
<li><a href="../../Picture_environment.html" title="Picture environment">Drawing Diagrams Directly in LaTeX</a></li>
<li><a href="../../TikZ_package.html" title="TikZ package">TikZ package</a></li></ul>
<h2><span class="mw-headline">References and Citations</span></h2>
<ul><li><a href="../../Bibliography_management_with_bibtex.html" title="Bibliography management with bibtex">Bibliography management with bibtex</a></li>
<li><a href="../../Bibliography_management_with_natbib.html" title="Bibliography management with natbib">Bibliography management with natbib</a></li>
<li><a href="../../Bibliography_management_with_biblatex.html" title="Bibliography management with biblatex">Bibliography management with biblatex</a></li>
<li><a href="../../Bibtex_bibliography_styles.html" title="Bibtex bibliography styles">Bibtex bibliography styles</a></li>
<li><a href="../../Natbib_bibliography_styles.html" title="Natbib bibliography styles">Natbib bibliography styles</a></li>
<li><a href="../../Natbib_citation_styles.html" title="Natbib citation styles">Natbib citation styles</a></li>
<li><a href="../../Biblatex_bibliography_styles.html" title="Biblatex bibliography styles">Biblatex bibliography styles</a></li>
<li><a href="../../Biblatex_citation_styles.html" title="Biblatex citation styles">Biblatex citation styles</a></li></ul>
<h2><span class="mw-headline">Languages</span></h2>
<ul><li><a href="../../Multilingual_typesetting_on_Overleaf_using_polyglossia_and_fontspec.html" title="Multilingual typesetting on Overleaf using polyglossia and fontspec">Multilingual typesetting on Overleaf using polyglossia and fontspec</a></li>
<li><a href="../../Multilingual_typesetting_on_Overleaf_using_babel_and_fontspec.html" title="Multilingual typesetting on Overleaf using babel and fontspec">Multilingual typesetting on Overleaf using babel and fontspec</a></li>
<li><a href="../../International_language_support.html" title="International language support">International language support</a></li>
<li><a href="../../Typesetting_quotations.html" title="Typesetting quotations">Quotations and quotation marks</a></li>
<li><a href="../../Arabic.html" title="Arabic">Arabic</a></li>
<li><a href="../../Chinese.html" title="Chinese">Chinese</a></li>
<li><a href="../../French.html" title="French">French</a></li>
<li><a href="../../German.html" title="German">German</a></li>
<li><a href="../../Greek.html" title="Greek">Greek</a></li>
<li><a href="../../Italian.html" title="Italian">Italian</a></li>
<li><a href="../../Japanese.html" title="Japanese">Japanese</a></li>
<li><a href="../../Korean.html" title="Korean">Korean</a></li>
<li><a href="../../Portuguese.html" title="Portuguese">Portuguese</a></li>
<li><a href="../../Russian.html" title="Russian">Russian</a></li>
<li><a href="../../Spanish.html" title="Spanish">Spanish</a></li></ul>
<h2><span class="mw-headline">Document structure</span></h2>
<ul><li><a href="../../Sections_and_chapters.html" title="Sections and chapters">Sections and chapters</a></li>
<li><a href="../../Table_of_contents.html" title="Table of contents">Table of contents</a></li>
<li><a href="../../Cross_referencing_sections%2c_equations_and_floats.html" title="Cross referencing sections, equations and floats">Cross referencing sections, equations and floats</a></li>
<li><a href="../../Indices.html" title="Indices">Indices</a></li>
<li><a href="../../Glossaries.html" title="Glossaries">Glossaries</a></li>
<li><a href="../../Nomenclatures.html" title="Nomenclatures">Nomenclatures</a></li>
<li><a href="../../Management_in_a_large_project.html" title="Management in a large project">Management in a large project</a></li>
<li><a href="../../Multi-file_LaTeX_projects.html" title="Multi-file LaTeX projects">Multi-file LaTeX projects</a></li>
<li><a href="../../Hyperlinks.html" title="Hyperlinks">Hyperlinks</a></li></ul>
<h2><span class="mw-headline">Formatting</span></h2>
<ul><li><a href="../../Lengths_in_LaTeX.html" title="Lengths in LaTeX">Lengths in <span class="texhtml" style="font-family:'CMU Serif', cmr10, LMRoman10-Regular, 'Times New Roman', 'Nimbus Roman No9 L', Times, serif">L<span style="text-transform:uppercase;font-size:70%;margin-left:-0.36em;vertical-align:0.3em;line-height:0;margin-right:-0.15em">a</span>T<span style="text-transform:uppercase;margin-left:-0.1667em;vertical-align:-0.5ex;line-height:0;margin-right:-0.125em">e</span>X</span></a></li>
<li><a href="../../Headers_and_footers.html" title="Headers and footers">Headers and footers</a></li>
<li><a href="../../Page_numbering.html" title="Page numbering">Page numbering</a></li>
<li><a href="../How_to_change_paragraph_spacing_in_LaTeX.html" class="mw-redirect" title="Paragraph formatting">Paragraph formatting</a></li>
<li><a href="../../Line_breaks_and_blank_spaces.html" title="Line breaks and blank spaces">Line breaks and blank spaces</a></li>
<li><a href="../../Text_alignment.html" title="Text alignment">Text alignment</a></li>
<li><a href="../../Page_size_and_margins.html" title="Page size and margins">Page size and margins</a></li>
<li><a href="../../Single_sided_and_double_sided_documents.html" title="Single sided and double sided documents">Single sided and double sided documents</a></li>
<li><a href="../../Multiple_columns.html" title="Multiple columns">Multiple columns</a></li>
<li><a href="../../Counters.html" title="Counters">Counters</a></li>
<li><a href="../../Code_listing.html" title="Code listing">Code listing</a></li>
<li><a href="../../Code_Highlighting_with_minted.html" title="Code Highlighting with minted">Code Highlighting with minted</a></li>
<li><a href="../../Using_colors_in_LaTeX.html" class="mw-redirect" title="Using colours in LaTeX">Using colours in LaTeX</a></li>
<li><a href="../../Footnotes.html" title="Footnotes">Footnotes</a></li>
<li><a href="../../Margin_notes.html" title="Margin notes">Margin notes</a></li></ul>
<h2><span class="mw-headline">Fonts</span></h2>
<ul><li><a href="../../Font_sizes%2c_families%2c_and_styles.html" title="Font sizes, families, and styles">Font sizes, families, and styles</a></li>
<li><a href="../../Font_typefaces.html" title="Font typefaces">Font typefaces</a></li>
<li><a href="../../XeLaTeX.html" title="XeLaTeX">Supporting modern fonts with <span class="texhtml" style="font-family:'CMU Serif', cmr10, LMRoman10-Regular, 'Times New Roman', 'Nimbus Roman No9 L', Times, serif">X<span style="text-transform:uppercase;margin-left:-0.1667em;vertical-align:-0.5ex;line-height:0;margin-right:-0.075em">Ǝ</span>L<span style="text-transform:uppercase;font-size:70%;margin-left:-0.36em;vertical-align:0.3em;line-height:0;margin-right:-0.15em">a</span>T<span style="text-transform:uppercase;margin-left:-0.1667em;vertical-align:-0.5ex;line-height:0;margin-right:-0.125em">e</span>X</span></a></li></ul>
<h2><span class="mw-headline">Presentations</span></h2>
<ul><li><a href="../../Beamer.html" title="Beamer">Beamer</a></li>
<li><a href="../../Powerdot.html" title="Powerdot">Powerdot</a></li>
<li><a href="../../Posters.html" title="Posters">Posters</a></li></ul>
<h2><span class="mw-headline">Commands</span></h2>
<ul><li><a href="../../Commands.html" title="Commands">Commands</a></li>
<li><a href="../../Environments.html" title="Environments">Environments</a></li></ul>
<h2><span class="mw-headline">Field specific</span></h2>
<ul><li><a href="../../Theorems_and_proofs.html" title="Theorems and proofs">Theorems and proofs</a></li>
<li><a href="../../Chemistry_formulae.html" title="Chemistry formulae">Chemistry formulae</a></li>
<li><a href="../../Feynman_diagrams.html" title="Feynman diagrams">Feynman diagrams</a></li>
<li><a href="../../Molecular_orbital_diagrams.html" title="Molecular orbital diagrams">Molecular orbital diagrams</a></li>
<li><a href="../../Chess_notation.html" title="Chess notation">Chess notation</a></li>
<li><a href="../../Knitting_patterns.html" title="Knitting patterns">Knitting patterns</a></li>
<li><a href="../../CircuiTikz_package.html" title="CircuiTikz package">CircuiTikz package</a></li>
<li><a href="../../Pgfplots_package.html" title="Pgfplots package">Pgfplots package</a></li>
<li><a href="../../Typesetting_exams_in_LaTeX.html" title="Typesetting exams in LaTeX">Typesetting exams in LaTeX</a></li>
<li><a href="../../Knitr.html" title="Knitr">Knitr</a></li>
<li><a href="../../Attribute_Value_Matrices.html" title="Attribute Value Matrices">Attribute Value Matrices</a></li></ul>
<h2><span class="mw-headline">Class files</span></h2>
<ul><li><a href="../../Understanding_packages_and_class_files.html" title="Understanding packages and class files">Understanding packages and class files</a></li>
<li><a href="../../Overleaf_and_TeX_Live.html" class="mw-redirect" title="List of packages and class files">List of packages and class files</a></li>
<li><a href="../../Writing_your_own_package.html" title="Writing your own package">Writing your own package</a></li>
<li><a href="../../Writing_your_own_class.html" title="Writing your own class">Writing your own class</a></li></ul>
<h2><span></span><span class="mw-headline">Advanced TeX/LaTeX</span></h2>
<ul><li><a href="../../Articles.html" title="Articles">In-depth technical articles on TeX/LaTeX</a></li></ul>




</div></div></div></div></main><footer class="fat-footer hidden-print"><div class="fat-footer-container" role="navigation" aria-label="Footer navigation"><div class="fat-footer-sections"><div class="footer-section" id="footer-brand"><a class="footer-brand" href="../../../../index.html" aria-label="Overleaf"></a></div><div class="footer-section"><h2 class="footer-section-heading">About</h2><ul class="list-unstyled"><li><a href="https://www.overleaf.com/about">About us</a></li><li><a href="https://www.overleaf.com/about/values">Our values</a></li><li><a href="https://www.overleaf.com/about/careers">Careers</a></li><li><a href="https://www.overleaf.com/for/press">Press &amp; awards</a></li><li><a href="https://www.overleaf.com/blog">Blog</a></li></ul></div><div class="footer-section"><h2 class="footer-section-heading">Learn</h2><ul class="list-unstyled"><li><a href="../../Learn_LaTeX_in_30_minutes.html">LaTeX in 30 minutes</a></li><li><a href="https://www.overleaf.com/latex/templates">Templates</a></li><li><a href="https://www.overleaf.com/events/webinars">Webinars</a></li><li><a href="../../Tutorials.html">Tutorials</a></li><li><a href="../../Inserting_Images.html">How to insert images</a></li><li><a href="../../Tables.html">How to create tables</a></li></ul></div><div class="footer-section"><h2 class="footer-section-heading">Plans &amp; pricing</h2><ul class="list-unstyled"><li><a href="https://www.overleaf.com/learn/how-to/Overleaf_premium_features">Premium features</a></li><li><a href="https://www.overleaf.com/user/subscription/plans?itm_referrer=footer-for-indv-groups">For individuals &amp; groups</a></li><li><a href="https://www.overleaf.com/for/enterprises">For enterprise</a></li><li><a href="https://www.overleaf.com/for/universities">For universities</a></li><li><a href="https://www.overleaf.com/user/subscription/plans?itm_referrer=footer-for-students#view=student">For students</a></li></ul></div><div class="footer-section"><h2 class="footer-section-heading">Get involved</h2><ul class="list-unstyled"><li><a href="https://www.overleaf.com/for/community/advisors">Become an Overleaf advisor</a></li><li><a href="https://forms.gle/67PSpN1bLnjGCmPQ9">Let us know what you think</a></li></ul></div><div class="footer-section"><h2 class="footer-section-heading">Help</h2><ul class="list-unstyled"><li><a href="https://www.overleaf.com/about/why-latex">Why LaTeX?</a></li><li><a href="../../../../learn.html">Documentation </a></li><li><a href="https://www.overleaf.com/contact">Contact us  </a></li><li><a href="https://status.overleaf.com/">Website status</a></li></ul></div></div><div class="fat-footer-base"><div class="fat-footer-base-section fat-footer-base-meta"><div class="fat-footer-base-item"> <div class="fat-footer-base-copyright">© 2024 Overleaf</div><a href="https://www.overleaf.com/legal">Privacy and Terms</a><a href="https://www.digital-science.com/security-certifications/">Compliance</a></div><ul class="fat-footer-base-item list-unstyled fat-footer-base-language"><li class="dropdown dropup subdued language-picker" dropdown><a class="dropdown-toggle" id="language-picker-toggle" href="#" dropdown-toggle data-ol-lang-selector-tooltip data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" aria-label="Select Language" tooltip="Language" title="Language"><i class="fa fa-fw fa-language"></i>
English</a><ul class="dropdown-menu" role="menu" aria-labelledby="language-picker-toggle"><li class="dropdown-header">Language</li><li class="lngOption"><a class="menu-indent" href="directlua.html" role="menuitem">English</a></li><li class="lngOption"><a class="menu-indent" href="https://cs.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">Čeština</a></li><li class="lngOption"><a class="menu-indent" href="https://es.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">Español</a></li><li class="lngOption"><a class="menu-indent" href="https://pt.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">Português</a></li><li class="lngOption"><a class="menu-indent" href="https://fr.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">Français</a></li><li class="lngOption"><a class="menu-indent" href="https://de.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">Deutsch</a></li><li class="lngOption"><a class="menu-indent" href="https://sv.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">Svenska</a></li><li class="lngOption"><a class="menu-indent" href="https://tr.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">Türkçe</a></li><li class="lngOption"><a class="menu-indent" href="https://it.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">Italiano</a></li><li class="lngOption"><a class="menu-indent" href="https://cn.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">简体中文</a></li><li class="lngOption"><a class="menu-indent" href="https://no.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">Norsk</a></li><li class="lngOption"><a class="menu-indent" href="https://ru.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">Русский</a></li><li class="lngOption"><a class="menu-indent" href="https://da.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">Dansk</a></li><li class="lngOption"><a class="menu-indent" href="https://ko.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">한국어</a></li><li class="lngOption"><a class="menu-indent" href="https://ja.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua" role="menuitem">日本語</a></li></ul></li></ul></div><div class="fat-footer-base-section fat-footer-base-social"><div class="fat-footer-base-item"><a class="fat-footer-social" href="https://twitter.com/overleaf"><i class="fa fa-twitter-square" aria-hidden="true"></i><div class="sr-only">Overleaf on Twitter</div></a><a class="fat-footer-social" href="https://www.facebook.com/overleaf.editor"><i class="fa fa-facebook-square" aria-hidden="true"></i><div class="sr-only">Overleaf on Facebook</div></a><a class="fat-footer-social" href="https://www.linkedin.com/company/writelatex-limited"><i class="fa fa-linkedin-square" aria-hidden="true"></i><div class="sr-only">Overleaf on LinkedIn</div></a></div></div></div></div></footer><div class="cookie-banner hidden-print hidden"><div class="cookie-banner-content">We only use cookies for essential purposes and to improve your experience on our site. You can find out more in our <a href="https://www.overleaf.com/legal#Cookies">cookie policy</a>.</div><div class="cookie-banner-actions"><button class="btn btn-link btn-sm" type="button" data-ol-cookie-banner-set-consent="essential">Essential cookies only</button><button class="btn btn-primary btn-sm" type="button" data-ol-cookie-banner-set-consent="all">Accept all cookies</button></div></div><div class="modal fade" tabindex="-1" role="dialog" data-ol-contact-form-modal="contact-us"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">Contact Us</h4></div><div class="modal-body contact-us-modal"><form data-ol-async-form data-ol-contact-form data-ol-contact-form-with-search name="contactForm" role="form" aria-label="Contact Us" action="https://www.overleaf.com/support"><input name="inbox" type="hidden" value="support"><span data-ol-not-sent><div data-ol-form-messages="" role="alert"></div><label>Subject</label><div class="form-group"><input class="field text medium span8 form-control" aria-label="Subject" name="subject" required autocomplete="off" maxlength="255"></div><div class="contact-suggestions" data-ol-search-results-wrapper hidden><p class="contact-suggestion-label" aria-live="polite">Have you checked our <a href="https://www.overleaf.com/learn/kb" target="_blank">knowledge base</a>?</p><ul class="contact-suggestion-list" data-ol-search-results aria-role="region" aria-label="Help articles matching your subject"></ul></div><label class="desc">Email</label><div class="form-group"><input class="field text medium span8 form-control" aria-label="Email" name="email" required type="email" spellcheck="false" value="" maxlength="255"></div><label class="desc" id="title12">Affected project URL (Optional)</label><div class="form-group"><input class="field text medium span8 form-control" name="projectUrl" aria-label="Affected project URL Optional"></div><label class="desc">Message</label><div class="form-group"><textarea class="field text medium span8 form-control" aria-label="Message" name="message" required type="text"></textarea></div><div class="form-group hidden"><input class="field text medium span8 form-control" aria-label="important message" name="important_message"></div><div class="form-group text-center"><button class="btn-primary btn btn-lg" type="submit" data-ol-disabled-inflight event-tracking="form-submitted-contact-us" event-tracking-mb="true" event-tracking-trigger="click" event-segmentation="{&quot;location&quot;:&quot;contact-us-form&quot;}"><span data-ol-inflight="idle" aria-label="Contact Us">Contact Us</span><span hidden data-ol-inflight="pending" aria-label="Sending">Sending&hellip;</span></button></div></span><span data-ol-sent hidden><p>Message sent! Our team will review it and reply by email.</p></span></form></div></div></div></div></body><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/6708-bb0ec2a596e2d79e281e.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/1299-340aed457cf26db6735c.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/6355-7163e9bedb3c31a04d77.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/2450-b356853f41e99815b7e0.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/5071-4caa6fbe5a39e716483c.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/2570-27469efce30426390030.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/7604-4813a9465eb5181932ed.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/7958-6dee6439f476be110b3e.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/2456-e8a135acd34ece76b735.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/9484-53dbcb6a83726e8175ee.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/8234-ab2cbc754c35edf623d7.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/5442-81e5ef7105f5588be644.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/8489-58002e7913f5e7202666.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==" src="../../../../../cdn.overleaf.com/js/modules/learn/pages/learn-3368073b3c035b5683a3.js"></script><script type="text/javascript" nonce="8vk13NpFvb3+pNUSMNKbYg==">window.addEventListener('DOMContentLoaded', function() {
	//- Look for bundle
	var cdnBlocked = typeof Frontend === 'undefined'
	//- Prevent loops
	var noCdnAlreadyInUrl = window.location.href.indexOf("nocdn=true") != -1
	if (cdnBlocked && !noCdnAlreadyInUrl && navigator.userAgent.indexOf("Googlebot") == -1) {
		//- Set query param, server will not set CDN url
		window.location.search += "&nocdn=true";
	}
})</script>
<!-- Mirrored from www.overleaf.com/learn/latex/Articles/An_Introduction_to_LuaTeX_(Part_2)%3A_Understanding_%5Cdirectlua by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 12 Apr 2024 14:03:03 GMT -->
</html>